# useEffect

## å‚è€ƒ

### useEffect(setup, dependencies?)

åœ¨ç»„ä»¶çš„é¡¶å±‚è°ƒç”¨ useEffect ä»¥å£°æ˜ä¸€ä¸ª useEffectï¼š

```jsx
import { useState, useEffect } from "react";
import { createConnection } from "./chat.js";

function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState("https://localhost:1234");

  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => {
      connection.disconnect();
    };
  }, [serverUrl, roomId]);
  // ...
}
```

[è¯·å‚é˜…ä¸‹é¢çš„æ›´å¤šç¤ºä¾‹ã€‚](#ç”¨æ³•)

#### å‚æ•°

- setupï¼šå…·æœ‰ useEffect é€»è¾‘çš„å‡½æ•°ã€‚ä½ çš„è®¾ç½®å‡½æ•°ä¹Ÿå¯ä»¥é€‰æ‹©è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ã€‚å½“ä½ çš„ç»„ä»¶è¢«æ·»åŠ åˆ° DOM æ—¶ï¼ŒReact å°†è¿è¡Œä½ çš„è®¾ç½®å‡½æ•°ã€‚åœ¨æ¯æ¬¡ä½¿ç”¨æ›´æ”¹çš„ä¾èµ–é‡æ–°æ¸²æŸ“åï¼ŒReact å°†é¦–å…ˆä½¿ç”¨æ—§å€¼è¿è¡Œæ¸…ç†å‡½æ•°ï¼ˆå¦‚æœä½ æä¾›äº†å®ƒï¼‰ï¼Œç„¶åä½¿ç”¨æ–°å€¼è¿è¡Œä½ çš„è®¾ç½®å‡½æ•°ã€‚åœ¨ä½ çš„ç»„ä»¶ä» DOM ä¸­ç§»é™¤åï¼ŒReact å°†è¿è¡Œä½ çš„æ¸…ç†å‡½æ•°ã€‚

- å¯é€‰ dependenciesï¼šsetup ä»£ç ä¸­å¼•ç”¨çš„æ‰€æœ‰ååº”å€¼çš„åˆ—è¡¨ã€‚ååº”å€¼åŒ…æ‹¬å±æ€§ã€çŠ¶æ€ä»¥åŠç›´æ¥åœ¨ç»„ä»¶ä¸»ä½“å†…å£°æ˜çš„æ‰€æœ‰å˜é‡å’Œå‡½æ•°ã€‚å¦‚æœä½ çš„ linter æ˜¯ ä¸º React é…ç½®ï¼Œå®ƒå°†éªŒè¯æ¯ä¸ªååº”å€¼æ˜¯å¦æ­£ç¡®æŒ‡å®šä¸ºä¾èµ–ã€‚ä¾èµ–åˆ—è¡¨å¿…é¡»å…·æœ‰æ’å®šæ•°é‡çš„æ¡ç›®ï¼Œå¹¶ä¸”åƒ [dep1, dep2, dep3] ä¸€æ ·å†™æˆå†…è”ã€‚React å°†ä½¿ç”¨ Object.is æ¯”è¾ƒå°†æ¯ä¸ªä¾èµ–ä¸å…¶å…ˆå‰çš„å€¼è¿›è¡Œæ¯”è¾ƒã€‚å¦‚æœçœç•¥æ­¤å‚æ•°ï¼Œä½ çš„ useEffect å°†åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“ç»„ä»¶åé‡æ–°è¿è¡Œã€‚æŸ¥çœ‹ä¼ é€’ä¾èµ–æ•°ç»„ã€ç©ºæ•°ç»„å’Œå®Œå…¨ä¸ä¾èµ–ä¹‹é—´çš„åŒºåˆ«ã€‚

#### è¿”å›

useEffect è¿”å› undefinedã€‚

#### æ³¨æ„äº‹é¡¹

- useEffect æ˜¯ä¸€ä¸ª Hookï¼Œæ‰€ä»¥ä½ åªèƒ½åœ¨ä½ çš„ç»„ä»¶çš„é¡¶å±‚æˆ–è€…ä½ è‡ªå·±çš„é’©å­ä¸­è°ƒç”¨å®ƒã€‚ä½ ä¸èƒ½åœ¨å¾ªç¯æˆ–æ¡ä»¶å†…è°ƒç”¨å®ƒã€‚å¦‚æœéœ€è¦ï¼Œæå–ä¸€ä¸ªæ–°ç»„ä»¶å¹¶å°†çŠ¶æ€ç§»å…¥å…¶ä¸­ã€‚

- å¦‚æœä½ ä¸å°è¯•ä¸æŸäº›å¤–éƒ¨ç³»ç»ŸåŒæ­¥ï¼Œä½ å¯èƒ½ä¸éœ€è¦ useEffect

- å½“ä¸¥æ ¼æ¨¡å¼æ‰“å¼€æ—¶ï¼ŒReact å°†åœ¨ç¬¬ä¸€æ¬¡çœŸæ­£è®¾ç½®ä¹‹å‰è¿è¡Œä¸€ä¸ªé¢å¤–çš„ä»…å¼€å‘è®¾ç½®+æ¸…ç†å‘¨æœŸã€‚è¿™æ˜¯ä¸€ä¸ªå‹åŠ›æµ‹è¯•ï¼Œå¯ç¡®ä¿ä½ çš„æ¸…ç†é€»è¾‘ â€œmirrorsâ€ ä½ çš„è®¾ç½®é€»è¾‘ï¼Œå¹¶ç¡®ä¿å®ƒåœæ­¢æˆ–æ’¤æ¶ˆè®¾ç½®æ­£åœ¨æ‰§è¡Œçš„ä»»ä½•æ“ä½œã€‚å¦‚æœè¿™å¯¼è‡´é—®é¢˜ï¼Œå®ç°æ¸…ç†å‡½æ•°ã€‚

- å¦‚æœä½ çš„æŸäº›ä¾èµ–æ˜¯åœ¨ç»„ä»¶å†…éƒ¨å®šä¹‰çš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œåˆ™å­˜åœ¨å®ƒä»¬ä¼šå¯¼è‡´ useEffect é‡æ–°è¿è¡Œé¢‘ç‡è¶…è¿‡æ‰€éœ€é¢‘ç‡çš„é£é™©ã€‚è¦è§£å†³æ­¤é—®é¢˜ï¼Œè¯·åˆ é™¤ä¸å¿…è¦çš„ object å’Œ å‡½æ•° ä¾èµ–ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ useEffect å™¨ä¹‹å¤–è¿›è¡Œ æå–çŠ¶æ€æ›´æ–° å’Œ é React æ€§é€»è¾‘ã€‚

- å¦‚æœä½ çš„ useEffect ä¸æ˜¯ç”±äº¤äº’ï¼ˆå¦‚ç‚¹å‡»ï¼‰å¼•èµ·çš„ï¼ŒReact é€šå¸¸ä¼šè®©æµè§ˆå™¨åœ¨è¿è¡Œä½ çš„ useEffect ä¹‹å‰å…ˆç»˜åˆ¶æ›´æ–°çš„å±å¹•ã€‚å¦‚æœä½ çš„æ•ˆæœæ­£åœ¨æ‰§è¡Œä¸€äº›è§†è§‰æ“ä½œï¼ˆä¾‹å¦‚ï¼Œå®šä½å·¥å…·æç¤ºï¼‰ï¼Œå¹¶ä¸”å»¶è¿Ÿå¾ˆæ˜æ˜¾ï¼ˆä¾‹å¦‚ï¼Œå®ƒé—ªçƒï¼‰ï¼Œè¯·å°† useEffect æ›¿æ¢ä¸º useLayoutEffectã€‚

- å¦‚æœä½ çš„æ•ˆæœæ˜¯ç”±äº¤äº’ï¼ˆå¦‚ç‚¹å‡»ï¼‰å¼•èµ·çš„ï¼ŒReact å¯èƒ½ä¼šåœ¨æµè§ˆå™¨ç»˜åˆ¶æ›´æ–°çš„å±å¹•ä¹‹å‰è¿è¡Œä½ çš„æ•ˆæœã€‚è¿™å¯ç¡®ä¿äº‹ä»¶ç³»ç»Ÿå¯ä»¥è§‚å¯Ÿåˆ°æ•ˆæœçš„ç»“æœã€‚é€šå¸¸ï¼Œè¿™ä¼šæŒ‰é¢„æœŸå·¥ä½œã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ å¿…é¡»å°†å·¥ä½œæ¨è¿Ÿåˆ°ç»˜åˆ¶ä¹‹åï¼Œä¾‹å¦‚ alert()ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ setTimeoutã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚é˜… reactwg/react-18/128ã€‚

- å³ä½¿ä½ çš„æ•ˆæœæ˜¯ç”±äº¤äº’ï¼ˆå¦‚ç‚¹å‡»ï¼‰å¼•èµ·çš„ï¼ŒReact ä¹Ÿå¯èƒ½å…è®¸æµè§ˆå™¨åœ¨å¤„ç†æ•ˆæœå†…çš„çŠ¶æ€æ›´æ–°ä¹‹å‰é‡æ–°ç»˜åˆ¶å±å¹•ã€‚é€šå¸¸ï¼Œè¿™ä¼šæŒ‰é¢„æœŸå·¥ä½œã€‚ä½†æ˜¯ï¼Œå¦‚æœå¿…é¡»é˜»æ­¢æµè§ˆå™¨é‡æ–°ç»˜åˆ¶å±å¹•ï¼Œåˆ™éœ€è¦å°† useEffect æ›¿æ¢ä¸º useLayoutEffectã€‚

- useEffect ä»…åœ¨å®¢æˆ·ç«¯ä¸Šè¿è¡Œã€‚å®ƒä»¬ä¸ä¼šåœ¨æœåŠ¡å™¨æ¸²æŸ“æœŸé—´è¿è¡Œã€‚

## ç¬¬äºŒä¸ªå‚æ•°çš„ä¸‰ç§ç”¨æ³•

### ä¸å¡«ä»»ä½•å†…å®¹

åœ¨æ¯ä¸€æ¬¡æ¸²æŸ“ï¼ˆåŒ…æ‹¬é¦–æ¬¡ï¼‰åéƒ½æ‰§è¡Œã€‚

### ä¾èµ–ç©ºæ•°ç»„

[] (ç©ºæ•°ç»„) ä»…åœ¨ç»„ä»¶é¦–æ¬¡æ¸²æŸ“ï¼ˆæŒ‚è½½ï¼‰åæ‰§è¡Œ 1 æ¬¡ã€‚

### ä¾èµ–ä¸€ä¸ªå€¼

åœ¨é¦–æ¬¡æ¸²æŸ“åæ‰§è¡Œï¼Œå¹¶ä¸”åœ¨ count å˜é‡å‘ç”Ÿå˜åŒ–åçš„æ¯ä¸€æ¬¡æ¸²æŸ“åæ‰§è¡Œã€‚

## ç”¨æ³•

### è¿æ¥åˆ°å¤–éƒ¨ç³»ç»Ÿ

æœ‰äº›ç»„ä»¶åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæ—¶ï¼Œéœ€è¦ä¸ç½‘ç»œã€æŸäº›æµè§ˆå™¨ API æˆ–ç¬¬ä¸‰æ–¹åº“ä¿æŒè¿æ¥ã€‚è¿™äº›ç³»ç»Ÿä¸å— React æ§åˆ¶ï¼Œå› æ­¤å®ƒä»¬è¢«ç§°ä¸ºå¤–éƒ¨ç³»ç»Ÿã€‚

è¦åœ¨ç»„ä»¶çš„é¡¶å±‚è°ƒç”¨ å°†ä½ çš„ç»„ä»¶è¿æ¥åˆ°æŸä¸ªå¤–éƒ¨ç³»ç»Ÿï¼Œè¯·è°ƒç”¨ useEffectï¼š

```jsx
import { useState, useEffect } from "react";
import { createConnection } from "./chat.js";

function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState("https://localhost:1234");

  useEffect(() => {
    const connection = createConnection(serverUrl, roomId);
    connection.connect();
    return () => {
      connection.disconnect();
    };
  }, [serverUrl, roomId]);
  // ...
}
```

- ä½ éœ€è¦å°†ä¸¤ä¸ªå‚æ•°ä¼ é€’ç»™ useEffectï¼š
  1. å…·æœ‰è¿æ¥åˆ°è¯¥ç³»ç»Ÿçš„ setup code çš„è®¾ç½®å‡½æ•°ã€‚
     - å®ƒåº”è¯¥è¿”å›ä¸€ä¸ªæ¸…ç†å‡½æ•°ï¼Œå…¶ä¸­åŒ…å«ä¸è¯¥ç³»ç»Ÿæ–­å¼€è¿æ¥çš„ æ¸…ç†ä»£ç ã€‚
  2. ä¾èµ–åˆ—è¡¨ï¼ŒåŒ…æ‹¬åœ¨è¿™äº›å‡½æ•°ä¸­ä½¿ç”¨çš„ç»„ä»¶ä¸­çš„æ¯ä¸ªå€¼ã€‚

**React ä¼šåœ¨å¿…è¦æ—¶è°ƒç”¨ä½ çš„è®¾ç½®å’Œæ¸…ç†å‡½æ•°ï¼Œè¿™å¯èƒ½ä¼šå‘ç”Ÿå¤šæ¬¡ï¼š**

1. ç»„ä»¶æŒ‚è½½æ—¶è¿è¡Œè®¾ç½®ä»£ç 

   ```jsx
   useEffect(() => {
     console.log("è®¾ç½®ä»£ç è¿è¡Œ"); // ç»„ä»¶æŒ‚è½½æ—¶æ‰§è¡Œ
     return () => {
       console.log("æ¸…ç†ä»£ç è¿è¡Œ");
     };
   }, []);
   ```

   é¦–æ¬¡æ¸²æŸ“ï¼šåªæœ‰è®¾ç½®å‡½æ•°æ‰§è¡Œ

   ç”Ÿäº§ç¯å¢ƒè¡¨ç°ï¼šç»„ä»¶æ·»åŠ åˆ° DOM åç«‹å³è¿è¡Œè®¾ç½®å‡½æ•°

   å¼€å‘ç¯å¢ƒè¡¨ç°ï¼šåœ¨ä¸¥æ ¼æ¨¡å¼ä¸‹ï¼ŒReact å¯èƒ½ä¼šå…ˆæŒ‚è½½ â†’ å¸è½½ â†’ é‡æ–°æŒ‚è½½ç»„ä»¶æ¥æ£€æµ‹é—®é¢˜

2. ä¾èµ–é¡¹å˜åŒ–æ—¶çš„æ‰§è¡Œé¡ºåº

   ```jsx
   useEffect(() => {
     console.log("è®¾ç½®ä»£ç è¿è¡Œï¼Œå½“å‰count:", count);
     return () => {
       console.log("æ¸…ç†ä»£ç è¿è¡Œï¼Œä¸Šä¸€ä¸ªcount:", count);
     };
   }, [count]); // ä¾èµ–count
   ```

   å½“ count ä» 1 å˜ä¸º 2 æ—¶çš„æ‰§è¡Œé¡ºåºï¼š

   æ¸…ç†é˜¶æ®µï¼šä½¿ç”¨æ—§å€¼(1)è¿è¡Œæ¸…ç†å‡½æ•°

   è®¾ç½®é˜¶æ®µï¼šä½¿ç”¨æ–°å€¼(2)è¿è¡Œè®¾ç½®å‡½æ•°

3. ç»„ä»¶å¸è½½æ—¶çš„æ¸…ç†

   ```jsx
   useEffect(() => {
     const timer = setInterval(() => {}, 1000);
     return () => {
       clearInterval(timer); // ç»„ä»¶å¸è½½æ—¶æ‰§è¡Œ
     };
   }, []);
   ```

   å½“ç»„ä»¶ä» DOM ç§»é™¤æ—¶ï¼ŒReact ä¼šæ‰§è¡Œæœ€åä¸€æ¬¡æ¸…ç†

   è¿™æ˜¯é˜²æ­¢å†…å­˜æ³„æ¼çš„å…³é”®æœºåˆ¶

- å®é™…åœºæ™¯ç¤ºä¾‹
  è®¢é˜…æ•°æ®æºç¤ºä¾‹

  ```jsx
  useEffect(() => {
    console.log("è®¢é˜…ç”¨æˆ·æ•°æ®ï¼ŒID:", userId);
    const subscription = dataSource.subscribe(userId);
    return () => {
      console.log("å–æ¶ˆè®¢é˜…ï¼ŒID:", userId);
      subscription.unsubscribe();
    };
  }, [userId]); // ä¾èµ– userId
  ```

  å½“ userId å˜åŒ–æ—¶çš„æ‰§è¡Œæµç¨‹ï¼š

  1. ç”¨æˆ· A(id=1)è¿›å…¥é¡µé¢ï¼š

     è¾“å‡ºï¼š"è®¢é˜…ç”¨æˆ·æ•°æ®ï¼ŒID:1"

  2. ç”¨æˆ·åˆ‡æ¢åˆ°ç”¨æˆ· B(id=2)ï¼š

     è¾“å‡ºï¼š"å–æ¶ˆè®¢é˜…ï¼ŒID:1" (æ¸…ç†æ—§è®¢é˜…)

     è¾“å‡ºï¼š"è®¢é˜…ç”¨æˆ·æ•°æ®ï¼ŒID:2" (è®¾ç½®æ–°è®¢é˜…)

  3. ç¦»å¼€é¡µé¢ï¼š

     è¾“å‡ºï¼š"å–æ¶ˆè®¢é˜…ï¼ŒID:2" (æœ€ç»ˆæ¸…ç†)

- ä¸ºä»€ä¹ˆéœ€è¦è¿™ç§æœºåˆ¶ï¼Ÿ
  èµ„æºç®¡ç†ï¼šé¿å…å†…å­˜æ³„æ¼(å¦‚æœªæ¸…é™¤çš„å®šæ—¶å™¨ã€è®¢é˜…)

  çŠ¶æ€ä¸€è‡´æ€§ï¼šç¡®ä¿ Effect æ€»æ˜¯ä½¿ç”¨æœ€æ–°çš„ props å’Œ state

  ç«æ€æ¡ä»¶é¢„é˜²ï¼šæ¸…ç†å‡½æ•°å¯ä»¥å–æ¶ˆæ—§çš„å¼‚æ­¥è¯·æ±‚

- å¼€å‘ vs ç”Ÿäº§ç¯å¢ƒå·®å¼‚

  - å¼€å‘ç¯å¢ƒï¼š

    ä¸¥æ ¼æ¨¡å¼ä¸‹ä¼šæ•…æ„å¤šæ¬¡æŒ‚è½½/å¸è½½ç»„ä»¶

    å¸®åŠ©ä½ å‘ç°å¿˜è®°æ¸…ç†èµ„æºçš„é—®é¢˜

  - ç”Ÿäº§ç¯å¢ƒï¼š

    æ›´ç›´æ¥çš„æ‰§è¡Œæµç¨‹

    ä½†åŸºæœ¬æœºåˆ¶ä¿æŒä¸å˜

- æœ€ä½³å®è·µ
  æ¯ä¸ª Effect åªåšä¸€ä»¶äº‹ï¼š

  ```jsx
  // å¥½ï¼šåˆ†ç¦»å…³æ³¨ç‚¹
  useEffect(() => {
    /* è®¢é˜…é€»è¾‘ */
  }, [userId]);
  useEffect(() => {
    /* åŠ¨ç”»é€»è¾‘ */
  }, []);
  ```

  è¿”å›æ¸…ç†å‡½æ•°ï¼š

  ```jsx
  useEffect(() => {
    const handler = () => {};
    window.addEventListener("resize", handler);
    return () => window.removeEventListener("resize", handler);
  }, []);
  ```

  æ­£ç¡®å¤„ç†ä¾èµ–ï¼š

  ```jsx
  useEffect(() => {
    // ä¾èµ–æ‰€æœ‰ç”¨åˆ°çš„å¤–éƒ¨å€¼
  }, [count, userId]);
  ```

  ç†è§£è¿™ç§"è®¾ç½® â†’ æ¸…ç† â†’ è®¾ç½®"çš„å¾ªç¯æ¨¡å¼ï¼Œæ˜¯æŒæ¡ React useEffect ç®¡ç†çš„å…³é”®ã€‚è¿™ç¡®ä¿äº†èµ„æºè¢«æ­£ç¡®ç®¡ç†ï¼Œåº”ç”¨è¡Œä¸ºå¯é¢„æµ‹ã€‚

### è‡ªå®šä¹‰é’©å­ä¸­çš„å°è£… useEffect

useEffect æ˜¯ä¸€ä¸ª â€œåº”æ€¥æ–¹æ¡ˆâ€ï¼šï¼Œå½“ä½ éœ€è¦ â€œèµ°å‡º Reactâ€ å¹¶ä¸”æ²¡æœ‰æ›´å¥½çš„å†…ç½®è§£å†³æ–¹æ¡ˆé€‚åˆä½ çš„ç”¨ä¾‹æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚å¦‚æœä½ å‘ç°è‡ªå·±ç»å¸¸éœ€è¦æ‰‹åŠ¨ç¼–å†™ useEffectï¼Œè¿™é€šå¸¸è¡¨æ˜ä½ éœ€è¦ä¸ºç»„ä»¶æ‰€ä¾èµ–çš„å¸¸è§è¡Œä¸ºæå–ä¸€äº› è‡ªå®šä¹‰é’©å­ã€‚

ä¾‹å¦‚ï¼Œè¿™ä¸ª useChatRoom è‡ªå®šä¹‰é’©å­ â€œhidesâ€ ä½ çš„ useEffect çš„é€»è¾‘èƒŒåæ˜¯ä¸€ä¸ªæ›´å…·å£°æ˜æ€§çš„ APIï¼š

```jsx
function useChatRoom({ serverUrl, roomId }) {
  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId,
    };
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId, serverUrl]);
}
```

ç„¶åä½ å¯ä»¥åƒè¿™æ ·ä»ä»»ä½•ç»„ä»¶ä½¿ç”¨å®ƒï¼š

```jsx
function ChatRoom({ roomId }) {
  const [serverUrl, setServerUrl] = useState("https://localhost:1234");

  useChatRoom({
    roomId: roomId,
    serverUrl: serverUrl,
  });
}
// ...
```

React ç”Ÿæ€ç³»ç»Ÿä¸­è¿˜æœ‰è®¸å¤šä¼˜ç§€çš„è‡ªå®šä¹‰é’©å­å¯ç”¨äºå„ç§ç”¨é€”ã€‚

### æ§åˆ¶é React å°éƒ¨ä»¶

æœ‰æ—¶ï¼Œä½ å¸Œæœ›ä½¿å¤–éƒ¨ç³»ç»Ÿä¸ç»„ä»¶çš„æŸäº›å±æ€§æˆ–çŠ¶æ€ä¿æŒåŒæ­¥ã€‚

ä¾‹å¦‚ï¼Œå¦‚æœä½ æœ‰ä¸€ä¸ªç¬¬ä¸‰æ–¹åœ°å›¾å°éƒ¨ä»¶æˆ–ä¸€ä¸ªæ²¡æœ‰ä½¿ç”¨ React ç¼–å†™çš„è§†é¢‘æ’­æ”¾å™¨ç»„ä»¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ useEffect æ¥è°ƒç”¨å®ƒçš„æ–¹æ³•ï¼Œä½¿å…¶çŠ¶æ€ä¸ä½ çš„ React ç»„ä»¶çš„å½“å‰çŠ¶æ€ç›¸åŒ¹é…ã€‚è¿™ä¸ª useEffect åˆ›å»ºäº†ä¸€ä¸ªåœ¨ map-widget.js ä¸­å®šä¹‰çš„ MapWidget ç±»çš„å®ä¾‹ã€‚å½“ä½ æ›´æ”¹ Map ç»„ä»¶çš„ zoomLevel å±æ€§æ—¶ï¼ŒuseEffect ä¼šè°ƒç”¨ç±»å®ä¾‹ä¸Šçš„ setZoom() ä»¥ä¿æŒåŒæ­¥ï¼š

```jsx
import { useRef, useEffect } from "react";
import { MapWidget } from "./map-widget.js";

export default function Map({ zoomLevel }) {
  const containerRef = useRef(null);
  const mapRef = useRef(null);

  useEffect(() => {
    if (mapRef.current === null) {
      mapRef.current = new MapWidget(containerRef.current);
    }

    const map = mapRef.current;
    map.setZoom(zoomLevel);
  }, [zoomLevel]);

  return <div style={{ width: 200, height: 200 }} ref={containerRef} />;
}
```

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œä¸éœ€è¦æ¸…ç†å‡½æ•°ï¼Œå› ä¸º MapWidget ç±»ä»…ç®¡ç†ä¼ é€’ç»™å®ƒçš„ DOM èŠ‚ç‚¹ã€‚ä»æ ‘ä¸­ç§»é™¤ Map React ç»„ä»¶åï¼ŒDOM èŠ‚ç‚¹å’Œ MapWidget ç±»å®ä¾‹éƒ½ä¼šè¢«æµè§ˆå™¨ JavaScript å¼•æ“è‡ªåŠ¨åƒåœ¾å›æ”¶ã€‚

### ä½¿ç”¨ useEffect è¯·æ±‚æ•°æ®

ä½ å¯ä»¥ä½¿ç”¨ useEffect ä¸ºä½ çš„ç»„ä»¶è·å–æ•°æ®ã€‚è¯·æ³¨æ„ï¼Œä½¿ç”¨æ¡†æ¶çš„æ•°æ®è¯·æ±‚æœºåˆ¶çš„ å¦‚æœä½ ä½¿ç”¨æ¡†æ¶ï¼Œ å°†æ¯”æ‰‹åŠ¨ç¼–å†™ useEffect æ›´æœ‰æ•ˆã€‚
å¦‚æœä½ æƒ³æ‰‹åŠ¨ä» useEffect ä¸­è·å–æ•°æ®ï¼Œä½ çš„ä»£ç å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š

```jsx
import { useState, useEffect } from 'react';
import { fetchBio } from './api.js';

export default function Page() {
  const [person, setPerson] = useState('Alice');
  const [bio, setBio] = useState(null);

    useEffect(() => {
    let ignore = false;  // 1. å®šä¹‰æ ‡å¿—å˜é‡
    setBio(null);        // 2. é‡ç½®çŠ¶æ€

    fetchBio(person).then(result => {  // 3. å‘èµ·è¯·æ±‚
        if (!ignore) {      // 4. æ£€æŸ¥æ ‡å¿—
        setBio(result);   // 5. å®‰å…¨æ›´æ–°çŠ¶æ€
        }
    });

    return () => {        // 6. æ¸…ç†å‡½æ•°
        ignore = true;      // 7. æ ‡è®°ä¸ºå¿½ç•¥
    };
    }, [person]);          // 8. ä¾èµ–personå˜åŒ–

  // ...
```

- ç«æ€æ¡ä»¶é—®é¢˜è¯´æ˜
  å‡è®¾ä»¥ä¸‹åœºæ™¯ï¼š

  å¿«é€Ÿåˆ‡æ¢ person ä»"Alice"åˆ°"Bob"å†åˆ°"Charlie"

  ä¸‰ä¸ªè¯·æ±‚ä¾æ¬¡å‘å‡ºï¼Œä½†å“åº”é¡ºåºå¯èƒ½æ˜¯ï¼š

  Bob çš„å“åº”(æ…¢)

  Alice çš„å“åº”(æœ€æ…¢)

  Charlie çš„å“åº”(æœ€å¿«)

  æ²¡æœ‰é˜²æŠ¤æ—¶ï¼ŒAlice çš„å“åº”å¯èƒ½æœ€ååˆ°è¾¾ï¼Œé”™è¯¯åœ°è¦†ç›–äº†å½“å‰æ˜¾ç¤ºçš„ Charlie çš„æ•°æ®ã€‚

  - ignore æœºåˆ¶å¦‚ä½•å·¥ä½œ

    - ç»„ä»¶æŒ‚è½½/æ›´æ–°æ—¶ï¼š
      ignore åˆå§‹åŒ–ä¸º false
      å‘èµ·æ–°è¯·æ±‚

    - person å˜åŒ–æ—¶(é‡æ–°æ¸²æŸ“)ï¼š

      - æ‰§è¡Œä¸Šä¸€æ¬¡ Effect çš„æ¸…ç†å‡½æ•°ï¼Œå°†æ—§è¯·æ±‚çš„ ignore è®¾ä¸º true

      - æ–° Effect è¿è¡Œï¼Œæ–°çš„ ignore å˜é‡(false)è¢«åˆ›å»º

    - è¯·æ±‚å®Œæˆæ—¶ï¼š

      - åªæœ‰ ignore ä¸º false çš„å“åº”ä¼šæ›´æ–°çŠ¶æ€

      - è¢«"å¿½ç•¥"çš„è¯·æ±‚å“åº”åˆ°è¾¾æ—¶ä¸ä¼šæ‰§è¡Œ setBio

  - ä¸ºä»€ä¹ˆè¿™ç§æ¨¡å¼æœ‰æ•ˆ
    é—­åŒ…æœºåˆ¶ï¼šæ¯ä¸ª Effect è°ƒç”¨éƒ½æœ‰è‡ªå·±çš„ ignore å˜é‡

    æ‰§è¡Œé¡ºåºä¿è¯ï¼šReact æ€»æ˜¯å…ˆæ‰§è¡Œå‰ä¸€ä¸ª Effect çš„æ¸…ç†ï¼Œå†è¿è¡Œæ–° Effect

    è¯·æ±‚éš”ç¦»ï¼šæ¯ä¸ªè¯·æ±‚çš„å“åº”å¤„ç†åªå½±å“è‡ªå·±çš„æ¸²æŸ“å‘¨æœŸ

  - å®é™…åº”ç”¨åœºæ™¯
    æœç´¢æ¡†è¾“å…¥ï¼šå¿«é€Ÿè¿ç»­è¾“å…¥æ—¶ï¼Œåªæ˜¾ç¤ºæœ€åè¾“å…¥çš„ç»“æœ

    é€‰é¡¹å¡åˆ‡æ¢ï¼šå¿«é€Ÿåˆ‡æ¢æ—¶ï¼Œåªæ˜¾ç¤ºæœ€åé€‰ä¸­é€‰é¡¹å¡çš„å†…å®¹

    åˆ†é¡µæ•°æ®ï¼šå¿«é€Ÿç¿»é¡µæ—¶ï¼Œç¡®ä¿æ˜¾ç¤ºæ­£ç¡®çš„é¡µé¢æ•°æ®

    - ç°ä»£æ›¿ä»£æ–¹æ¡ˆ
      è™½ç„¶è¿™ç§æ¨¡å¼æœ‰æ•ˆï¼Œä½†ç°ä»£ React å¼€å‘æ›´æ¨èï¼š

      - ä½¿ç”¨æ¡†æ¶æä¾›çš„æ•°æ®è·å–ï¼š

      Next.js çš„ getServerSideProps/getStaticProps

      Remix çš„ loader

      React Router çš„ loader

      - ä½¿ç”¨æ•°æ®è·å–åº“ï¼š

      SWR

      React Query

      Apollo Client(GraphQL)

è¿™äº›æ–¹æ¡ˆå†…ç½®äº†ç«æ€æ¡ä»¶å¤„ç†ã€ç¼“å­˜ã€é‡è¯•ç­‰é«˜çº§åŠŸèƒ½ã€‚

### æŒ‡å®šååº”ä¾èµ–

#### ä¾èµ–é¡¹å¿…é¡»å®Œæ•´å£°æ˜

React å¼ºè°ƒæ‰€æœ‰åœ¨ Effect å†…éƒ¨ä½¿ç”¨çš„å“åº”å¼å€¼ï¼ˆreactive valuesï¼‰éƒ½å¿…é¡»å£°æ˜ä¸ºä¾èµ–é¡¹ã€‚å“åº”å¼å€¼åŒ…æ‹¬ï¼š

- ç»„ä»¶ propsï¼ˆå¦‚ roomIdï¼‰

- ç»„ä»¶ stateï¼ˆå¦‚ serverUrlï¼‰

- ç»„ä»¶å†…éƒ¨å®šä¹‰çš„å˜é‡å’Œå‡½æ•°

```jsx
// âœ… æ­£ç¡®ï¼šæ‰€æœ‰ç”¨åˆ°çš„å“åº”å¼å€¼éƒ½å£°æ˜ä¸ºä¾èµ–
useEffect(() => {
  const connection = createConnection(serverUrl, roomId);
  connection.connect();
  return () => connection.disconnect();
}, [serverUrl, roomId]); // å¿…é¡»åŒ…å«æ‰€æœ‰ä¾èµ–
```

#### ä¸èƒ½é€‰æ‹©æ€§å¿½ç•¥ä¾èµ–

å¼€å‘è€…ä¸èƒ½éšæ„æŒ‘é€‰ä¾èµ–ï¼Œå¿…é¡»å®Œæ•´å£°æ˜æ‰€æœ‰ç”¨åˆ°çš„å“åº”å¼å€¼ã€‚å¦‚æœé—æ¼ä¾èµ–ï¼š

- React ä¼šåœ¨å¼€å‘æ—¶é€šè¿‡ lint è§„åˆ™æŠ¥é”™

- å¯èƒ½å¯¼è‡´ Effect æ— æ³•åŠæ—¶å“åº”æ•°æ®å˜åŒ–

```jsx
// ğŸ”´ é”™è¯¯ï¼šé—æ¼äº†serverUrlä¾èµ–
useEffect(() => {
  const connection = createConnection(serverUrl, roomId);
  // ...
}, [roomId]); // ç¼ºå°‘serverUrl
```

#### å‡å°‘ä¾èµ–çš„åˆæ³•æ–¹å¼

å¦‚æœç¡®å®éœ€è¦å‡å°‘ä¾èµ–ï¼Œåº”è¯¥é€šè¿‡ä»£ç ç»“æ„è°ƒæ•´æ¥å®ç°ï¼Œè€Œä¸æ˜¯å¿½ç•¥ lint è­¦å‘Šï¼š

- æ–¹å¼ä¸€ï¼šå°†å€¼ç§»å‡ºç»„ä»¶

  ```jsx
  const serverUrl = "https://localhost:1234"; // ä¸å†æ˜¯å“åº”å¼å€¼

  function ChatRoom({ roomId }) {
    useEffect(() => {
      const connection = createConnection(serverUrl, roomId);
      // ...
    }, [roomId]); // âœ… ç°åœ¨åªéœ€è¦roomId
  }
  ```

- æ–¹å¼äºŒï¼šä½¿ç”¨ useMemo/useCallback

```jsx
function ChatRoom({ roomId }) {
  const options = useMemo(
    () => ({
      serverUrl: "https://localhost:1234",
      roomId,
    }),
    [roomId]
  );

  useEffect(() => {
    const connection = createConnection(options);
    // ...
  }, [options]); // âœ… ä¾èµ–æ›´ç®€æ´
}
```

4. ç©ºä¾èµ–æ•°ç»„çš„ç‰¹æ®Šå«ä¹‰

```jsx
useEffect(() => {
  // è¿™æ®µä»£ç åªä¼šåœ¨ç»„ä»¶æŒ‚è½½æ—¶è¿è¡Œä¸€æ¬¡
}, []); // ç©ºæ•°ç»„è¡¨ç¤ºä¸ä¾èµ–ä»»ä½•å“åº”å¼å€¼
```

ç©ºæ•°ç»„è¡¨ç¤ºï¼š

Effect ä¸ä¾èµ–äºä»»ä½• props æˆ– state

åªåœ¨ç»„ä»¶æŒ‚è½½æ—¶è¿è¡Œä¸€æ¬¡

é€‚åˆåˆå§‹åŒ–é React ç›¸å…³çš„ç¬¬ä¸‰æ–¹åº“ç­‰åœºæ™¯

å½“ä½ çš„ç»„ä»¶çš„ä»»ä½•å±æ€§æˆ–çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼Œå…·æœ‰ç©ºä¾èµ–çš„ useEffect ä¸ä¼šé‡æ–°è¿è¡Œã€‚

#### ä¸è¦å‹åˆ¶ lint è­¦å‘Š

å®˜æ–¹å¼ºçƒˆåå¯¹è¿™ç§å†™æ³•ï¼š

```jsx
// ğŸ”´ å±é™©ï¼ä¸è¦è¿™æ ·åš
useEffect(() => {
  // ...
  // eslint-disable-next-line react-hooks/exhaustive-deps
}, []);
```

å‹åˆ¶ lint è­¦å‘Šä¼šå¯¼è‡´ï¼š

éš¾ä»¥å‘ç°çš„ bug

Effect æ— æ³•æ­£ç¡®å“åº”æ•°æ®å˜åŒ–

ä»£ç ç»´æŠ¤å›°éš¾

æ ¸å¿ƒæ€æƒ³æ€»ç»“

- è¯šå®å£°æ˜ä¾èµ–ï¼šEffect ç”¨åˆ°çš„æ‰€æœ‰å“åº”å¼å€¼éƒ½å¿…é¡»å£°æ˜

- é€šè¿‡é‡æ„è€Œéå‹åˆ¶æ¥ä¼˜åŒ–ï¼šå¦‚æœä¾èµ–è¿‡å¤šï¼Œåº”è¯¥é‡æ„ä»£ç è€Œéå¿½ç•¥è­¦å‘Š

- ä¾èµ–é¡¹å†³å®š Effect çš„æ‰§è¡Œæ—¶æœºï¼šReact æ ¹æ®ä¾èµ–å˜åŒ–å†³å®šæ˜¯å¦é‡æ–°æ‰§è¡Œ Effect

- ç©ºä¾èµ–æ•°ç»„æœ‰ç‰¹æ®Šå«ä¹‰ï¼šæ˜ç¡®è¡¨ç¤º Effect ä¸ä¾èµ–ä»»ä½•å“åº”å¼æ•°æ®

### æ ¹æ® useEffect çš„å…ˆå‰çŠ¶æ€æ›´æ–°çŠ¶æ€

å½“ä½ æƒ³æ ¹æ® useEffect çš„å…ˆå‰çŠ¶æ€æ›´æ–°çŠ¶æ€æ—¶ï¼Œä½ å¯èƒ½ä¼šé‡åˆ°é—®é¢˜ï¼š

```jsx
function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const intervalId = setInterval(() => {
      setCount(count + 1); // You want to increment the counter every second...
    }, 1000);
    return () => clearInterval(intervalId);
  }, [count]); // ğŸš© ... but specifying `count` as a dependency always resets the interval.
  // ...
}
```

ç”±äº count æ˜¯ä¸€ä¸ªååº”å€¼ï¼Œå› æ­¤å¿…é¡»åœ¨ä¾èµ–åˆ—è¡¨ä¸­æŒ‡å®šå®ƒã€‚ä½†æ˜¯ï¼Œè¿™ä¼šå¯¼è‡´æ¯æ¬¡ count æ›´æ”¹æ—¶é‡æ–°æ‰§è¡Œ useEffectï¼Œä»è€Œå¯¼è‡´ intervalId çš„æ¸…é™¤å’Œé‡æ–°è®¾ç½®ã€‚è¿™å¹¶ä¸ç†æƒ³ã€‚

è¦è§£å†³æ­¤é—®é¢˜ï¼Œé€šè¿‡ c => c + 1 çŠ¶æ€æ›´æ–°å™¨ åˆ° setCountï¼š

```jsx
import { useState, useEffect } from "react";

export default function Counter() {
  const [count, setCount] = useState(0);

  useEffect(() => {
    const intervalId = setInterval(() => {
      setCount(c + 1); // âœ… Pass a state updater
    }, 1000);
    return () => clearInterval(intervalId);
  }, []); // âœ… Now count is not a dependency

  return <h1>{count}</h1>;
}
```

### ç§»é™¤ä¸å¿…è¦çš„å¯¹è±¡ä¾èµ–

å¦‚æœä½ çš„ useEffect ä¾èµ–äºæ¸²æŸ“æœŸé—´åˆ›å»ºçš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œåˆ™å®ƒå¯èƒ½ä¼šè¿è¡Œå¾—å¤ªé¢‘ç¹ã€‚ä¾‹å¦‚ï¼Œæ­¤ useEffect åœ¨æ¯æ¬¡æ¸²æŸ“åé‡æ–°è¿æ¥ï¼Œå› ä¸º options å¯¹è±¡æ˜¯ æ¯ä¸ªæ¸²æŸ“éƒ½ä¸åŒï¼š

```jsx
const serverUrl = 'https://localhost:1234';

function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');

  const options = { // ğŸš© This object is created from scratch on every re-render
    serverUrl: serverUrl,
    roomId: roomId
  };

  useEffect(() => {
    const connection = createConnection(options); // It's used inside the Effect
    connection.connect();
    return () => connection.disconnect();
  }, [options]); // ğŸš© As a result, these dependencies are always different on a re-render
  // ...
```

ä¿®å¤åçš„ä»£ç ï¼Œç›´æ¥åœ¨ Effect å†…éƒ¨åˆ›å»ºå¯¹è±¡ï¼Œä¾èµ–åŸå§‹å€¼

```jsx
const serverUrl = "https://localhost:1234";

function ChatRoom({ roomId }) {
  const [message, setMessage] = useState("");

  useEffect(() => {
    const options = {
      serverUrl: serverUrl,
      roomId: roomId,
    };
    const connection = createConnection(options);
    connection.connect();
    return () => connection.disconnect();
  }, [roomId]); // âœ… serverUrlæ˜¯å¸¸é‡ï¼Œä¸éœ€è¦ä½œä¸ºä¾èµ–
  // ...
}
```

### åˆ é™¤ä¸å¿…è¦çš„å‡½æ•°ä¾èµ–

å¦‚æœä½ çš„ useEffect ä¾èµ–äºæ¸²æŸ“æœŸé—´åˆ›å»ºçš„å¯¹è±¡æˆ–å‡½æ•°ï¼Œåˆ™å®ƒå¯èƒ½ä¼šè¿è¡Œå¾—å¤ªé¢‘ç¹ã€‚ä¾‹å¦‚ï¼Œæ­¤ useEffect åœ¨æ¯æ¬¡æ¸²æŸ“åé‡æ–°è¿æ¥ï¼Œå› ä¸º createOptions å‡½æ•°æ˜¯ æ¯ä¸ªæ¸²æŸ“éƒ½ä¸åŒï¼š

```jsx
function ChatRoom({ roomId }) {
  const [message, setMessage] = useState('');

  function createOptions() { // ğŸš© This function is created from scratch on every re-render
    return {
      serverUrl: serverUrl,
      roomId: roomId
    };
  }

  useEffect(() => {
    const options = createOptions(); // It's used inside the Effect
    const connection = createConnection();
    connection.connect();
    return () => connection.disconnect();
  }, [createOptions]); // ğŸš© As a result, these dependencies are always different on a re-render
  // ...
```

å‡½æ•°å’Œå¯¹è±¡éƒ½æ˜¯å¼•ç”¨ç±»å‹ï¼Œä½œä¸ºä¾èµ–æœ‰ç›¸åŒçš„é—®é¢˜ã€‚

## æ•…éšœæ’é™¤

### æˆ‘çš„ useEffect åœ¨ç»„ä»¶æŒ‚è½½æ—¶è¿è¡Œä¸¤æ¬¡

å½“ä¸¥æ ¼æ¨¡å¼æ‰“å¼€æ—¶ï¼Œåœ¨å¼€å‘ä¸­ï¼ŒReact åœ¨å®é™…è®¾ç½®ä¹‹å‰é¢å¤–è¿è¡Œä¸€æ¬¡è®¾ç½®å’Œæ¸…ç†ã€‚

è¿™æ˜¯ä¸€ä¸ªå‹åŠ›æµ‹è¯•ï¼Œç”¨äºéªŒè¯ä½ çš„ useEffect é€»è¾‘æ˜¯å¦æ­£ç¡®å®ç°ã€‚å¦‚æœè¿™å¯¼è‡´å¯è§é—®é¢˜ï¼Œåˆ™è¯´æ˜ä½ çš„æ¸…ç†å‡½æ•°ç¼ºå°‘æŸäº›é€»è¾‘ã€‚æ¸…ç†å‡½æ•°åº”è¯¥åœæ­¢æˆ–æ’¤æ¶ˆè®¾ç½®å‡½æ•°æ­£åœ¨åšçš„ä»»ä½•äº‹æƒ…ã€‚ç»éªŒæ³•åˆ™æ˜¯ç”¨æˆ·ä¸åº”è¯¥èƒ½å¤ŸåŒºåˆ†è°ƒç”¨ä¸€æ¬¡çš„è®¾ç½®ï¼ˆå¦‚åœ¨ç”Ÿäº§ä¸­ï¼‰å’Œè®¾ç½® â†’ æ¸…ç† â†’ è®¾ç½®åºåˆ—ï¼ˆå¦‚åœ¨å¼€å‘ä¸­ï¼‰ã€‚

### æˆ‘çš„ useEffect åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“åè¿è¡Œ

é¦–å…ˆï¼Œæ£€æŸ¥ä½ æ˜¯å¦æ²¡æœ‰å¿˜è®°æŒ‡å®šä¾èµ–æ•°ç»„ï¼š

```jsx
useEffect(() => {
  // ...
}); // ğŸš© No dependency array: re-runs after every render!
```

å¦‚æœä½ æŒ‡å®šäº†ä¾èµ–æ•°ç»„ï¼Œä½†ä½ çš„ useEffect ä»ç„¶åœ¨å¾ªç¯ä¸­é‡æ–°è¿è¡Œï¼Œé‚£æ˜¯å› ä¸ºä½ çš„ä¸€ä¸ªä¾èµ–åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ—¶éƒ½ä¸åŒã€‚

ä½ å¯ä»¥é€šè¿‡æ‰‹åŠ¨å°†ä¾èµ–è®°å½•åˆ°æ§åˆ¶å°æ¥è°ƒè¯•æ­¤é—®é¢˜ï¼š

```jsx
useEffect(() => {
  // ..
}, [serverUrl, roomId]);
console.log([serverUrl, roomId]);
```

ç„¶åï¼Œä½ å¯ä»¥åœ¨æ§åˆ¶å°ä¸­å³é”®å•å‡»æ¥è‡ªä¸åŒé‡æ–°æ¸²æŸ“çš„æ•°ç»„ï¼Œå¹¶ä¸ºå®ƒä»¬é€‰æ‹© â€œå­˜å‚¨ä¸ºå…¨å±€å˜é‡â€ã€‚å‡è®¾ç¬¬ä¸€ä¸ªä¿å­˜ä¸º temp1ï¼Œç¬¬äºŒä¸ªä¿å­˜ä¸º temp2ï¼Œé‚£ä¹ˆä½ å¯ä»¥ä½¿ç”¨æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥ä¸¤ä¸ªæ•°ç»„ä¸­çš„æ¯ä¸ªä¾èµ–æ˜¯å¦ç›¸åŒï¼š

```jsx
Object.is(temp1[0], temp2[0]); // Is the first dependency the same between the arrays?
Object.is(temp1[1], temp2[1]); // Is the second dependency the same between the arrays?
Object.is(temp1[2], temp2[2]); // ... and so on for every dependency ...
```

- [æ ¹æ® useEffect çš„å…ˆå‰çŠ¶æ€æ›´æ–°çŠ¶æ€](#æ ¹æ®useEffectçš„å…ˆå‰çŠ¶æ€æ›´æ–°çŠ¶æ€)

- [ç§»é™¤ä¸å¿…è¦çš„å¯¹è±¡ä¾èµ–](#ç§»é™¤ä¸å¿…è¦çš„å¯¹è±¡ä¾èµ–)

- [åˆ é™¤ä¸å¿…è¦çš„å‡½æ•°ä¾èµ–](#åˆ é™¤ä¸å¿…è¦çš„å‡½æ•°ä¾èµ–)

### æˆ‘çš„ useEffect åœ¨æ— é™å¾ªç¯ä¸­ä¸æ–­é‡æ–°è¿è¡Œ

å¦‚æœä½ çš„ useEffect ä»¥æ— é™å¾ªç¯è¿è¡Œï¼Œåˆ™ä»¥ä¸‹ä¸¤ç‚¹å¿…é¡»ä¸ºçœŸï¼š

ä½ çš„ useEffect æ­£åœ¨æ›´æ–°ä¸€äº›çŠ¶æ€ã€‚

è¯¥çŠ¶æ€ä¼šå¯¼è‡´é‡æ–°æ¸²æŸ“ï¼Œä»è€Œå¯¼è‡´ useEffect çš„ä¾èµ–å‘ç”Ÿå˜åŒ–ã€‚

åœ¨å¼€å§‹è§£å†³é—®é¢˜ä¹‹å‰ï¼Œå…ˆé—®é—®è‡ªå·± useEffect æ˜¯å¦è¿æ¥åˆ°æŸä¸ªå¤–éƒ¨ç³»ç»Ÿï¼ˆå¦‚ DOMã€ç½‘ç»œã€ç¬¬ä¸‰æ–¹å°éƒ¨ä»¶ç­‰ï¼‰ã€‚ä¸ºä»€ä¹ˆä½ çš„ useEffect éœ€è¦è®¾ç½®çŠ¶æ€ï¼Ÿå®ƒæ˜¯å¦ä¸è¯¥å¤–éƒ¨ç³»ç»ŸåŒæ­¥ï¼Ÿæˆ–è€…ä½ æ˜¯å¦æ­£åœ¨å°è¯•ä½¿ç”¨å®ƒæ¥ç®¡ç†åº”ç”¨çš„æ•°æ®æµï¼Ÿ

å¦‚æœæ²¡æœ‰å¤–éƒ¨ç³»ç»Ÿï¼Œè¯·è€ƒè™‘ å®Œå…¨åˆ é™¤ useEffect æ˜¯å¦ä¼šç®€åŒ–ä½ çš„é€»è¾‘ã€‚

å¦‚æœä½ çœŸæ­£ä¸æŸä¸ªå¤–éƒ¨ç³»ç»ŸåŒæ­¥ï¼Œè¯·è€ƒè™‘ä½ çš„ useEffect åº”è¯¥æ›´æ–°çŠ¶æ€çš„åŸå› å’Œæ¡ä»¶ã€‚æœ‰ä»€ä¹ˆæ”¹å˜å½±å“äº†ä½ çš„ç»„ä»¶çš„è§†è§‰è¾“å‡ºå—ï¼Ÿå¦‚æœä½ éœ€è¦è·Ÿè¸ªæ¸²æŸ“æœªä½¿ç”¨çš„æŸäº›æ•°æ®ï¼Œå¼•ç”¨ï¼ˆä¸ä¼šè§¦å‘é‡æ–°æ¸²æŸ“ï¼‰å¯èƒ½æ›´åˆé€‚ã€‚éªŒè¯ä½ çš„ useEffect ä¸ä¼šæ¯”éœ€è¦æ›´å¤šåœ°æ›´æ–°çŠ¶æ€ï¼ˆå¹¶è§¦å‘é‡æ–°æ¸²æŸ“ï¼‰ã€‚

æœ€åï¼Œå¦‚æœä½ çš„ useEffect åœ¨æ­£ç¡®çš„æ—¶é—´æ›´æ–°çŠ¶æ€ï¼Œä½†ä»ç„¶å­˜åœ¨å¾ªç¯ï¼Œé‚£æ˜¯å› ä¸ºè¯¥çŠ¶æ€æ›´æ–°å¯¼è‡´ useEffect çš„ä¾èµ–ä¹‹ä¸€å‘ç”Ÿå˜åŒ–ã€‚é˜…è¯»[å¦‚ä½•è°ƒè¯•ä¾èµ–æ›´æ”¹ã€‚](#æˆ‘çš„useEffectåœ¨æ— é™å¾ªç¯ä¸­ä¸æ–­é‡æ–°è¿è¡Œ)

### å³ä½¿æˆ‘çš„ç»„ä»¶æ²¡æœ‰å¸è½½ï¼Œæˆ‘çš„æ¸…ç†é€»è¾‘ä»åœ¨è¿è¡Œ

æ¸…ç†å‡½æ•°ä¸ä»…åœ¨å¸è½½æœŸé—´è¿è¡Œï¼Œè€Œä¸”åœ¨æ¯æ¬¡é‡æ–°æ¸²æŸ“æ›´æ”¹ä¾èµ–ä¹‹å‰è¿è¡Œã€‚æ­¤å¤–ï¼Œåœ¨å¼€å‘ä¸­ï¼ŒReact åœ¨ç»„ä»¶æŒ‚è½½åç«‹å³é¢å¤–è¿è¡Œä¸€æ¬¡è®¾ç½®+æ¸…ç†ã€‚

å¦‚æœä½ æœ‰æ¸…ç†ä»£ç è€Œæ²¡æœ‰ç›¸åº”çš„è®¾ç½®ä»£ç ï¼Œé€šå¸¸æ˜¯ä»£ç å‘³é“ï¼ˆCode Smellï¼‰ï¼š
Code Smell:å¯èƒ½å­˜åœ¨æ½œåœ¨é—®é¢˜æˆ–ä¸è‰¯è®¾è®¡æ¨¡å¼çš„è­¦ç¤ºä¿¡å·

```jsx
useEffect(() => {
  // ğŸ”´ Avoid: Cleanup logic without corresponding setup logic
  return () => {
    doSomething();
  };
}, []);
```

ä½ çš„æ¸…ç†é€»è¾‘åº”è¯¥æ˜¯è®¾ç½®é€»è¾‘çš„ â€œsymmetricalâ€ï¼Œå¹¶ä¸”åº”è¯¥åœæ­¢æˆ–æ’¤æ¶ˆä»»ä½•è®¾ç½®æ‰€åšçš„äº‹æƒ…ï¼š

```jsx
useEffect(() => {
  const connection = createConnection(serverUrl, roomId);
  connection.connect();
  return () => {
    connection.disconnect();
  };
}, [serverUrl, roomId]);
```

### æˆ‘çš„ useEffect åšäº†ä¸€äº›è§†è§‰ useEffectï¼Œæˆ‘åœ¨å®ƒè¿è¡Œå‰çœ‹åˆ°äº†é—ªçƒ

å¦‚æœä½ çš„ useEffect å¿…é¡»é˜»æ­¢æµè§ˆå™¨è®¿é—® ç»˜ç”»å±å¹•ï¼Œè¯·å°† useEffect æ›¿æ¢ä¸º useLayoutEffectã€‚è¯·æ³¨æ„ï¼Œç»å¤§å¤šæ•°æ•ˆæœéƒ½ä¸éœ€è¦è¿™æ ·åšã€‚ä»…å½“åœ¨æµè§ˆå™¨ç»˜åˆ¶ä¹‹å‰è¿è¡Œæ•ˆæœè‡³å…³é‡è¦æ—¶ï¼Œä½ æ‰éœ€è¦å®ƒï¼šä¾‹å¦‚ï¼Œåœ¨ç”¨æˆ·çœ‹åˆ°ä¹‹å‰æµ‹é‡å’Œå®šä½å·¥å…·æç¤ºã€‚
