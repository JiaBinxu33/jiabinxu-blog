<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>åŸºäº Next.js çš„åŒ Token æ— æ„Ÿåˆ·æ–°è®¤è¯ç³»ç»Ÿ - å­¦ä¹ ç¬”è®° | è´¾æ»¨æ—­çš„ä¸ªäººæŠ€æœ¯åšå®¢</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/jiabinxu-blog/R-C.png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css">
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <meta name="description" content="å‰ç«¯å¼€å‘çŸ¥è¯†ä½“ç³»">
    <meta name="algolia-site-verification" content="8AB7B96237F774B9">
    
    <link rel="preload" href="/jiabinxu-blog/assets/css/0.styles.6e2e750c.css" as="style"><link rel="preload" href="/jiabinxu-blog/assets/js/app.f81cf313.js" as="script"><link rel="preload" href="/jiabinxu-blog/assets/js/3.bb87b8ff.js" as="script"><link rel="preload" href="/jiabinxu-blog/assets/js/2.180c3171.js" as="script"><link rel="preload" href="/jiabinxu-blog/assets/js/70.d4fc17a1.js" as="script"><link rel="prefetch" href="/jiabinxu-blog/assets/js/1.c3ce1b0a.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/12.3c2a6c83.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/13.3c49b8de.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/14.91b5c8e3.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/15.ef4b17e3.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/16.23f5619b.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/17.4bb3669d.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/18.664e814e.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/19.21ad7801.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/20.d4db7480.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/21.31141967.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/22.8a3f30d9.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/23.97e9a047.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/24.78676adc.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/25.3050b4ef.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/26.cd43fc60.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/27.f04bcbc6.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/28.f5223a9d.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/29.52241c93.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/30.2e981bab.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/31.d58d5448.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/32.fb28f85b.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/33.d10d4810.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/34.f89661dc.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/35.a2c20bce.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/36.e39b3fc8.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/37.edabae48.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/38.8f37da54.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/39.86e08cd4.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/4.3ff6f6b3.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/40.42a528d4.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/41.46dbe14a.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/42.0b72d4b8.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/43.7d892d86.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/44.164a4f16.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/45.5bc0d409.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/46.82b75b59.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/47.e959a5f5.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/48.cc983ac3.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/49.ed08971b.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/5.9cbc22ee.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/50.f9457251.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/51.63e6d8ea.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/52.51ebfdbe.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/53.2e948603.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/54.1907287a.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/55.2aca8e9e.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/56.53572a11.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/57.6c8d55a3.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/58.7c01df11.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/59.1df3a578.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/6.7cbe58bc.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/60.bf31f66a.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/61.f2feff3d.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/62.d36efdc6.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/63.824240b9.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/64.6e5633db.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/65.0bc9c8bd.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/66.b03cfd91.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/67.3a221345.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/68.23192d8d.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/69.e15e8a6b.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/7.942695b2.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/71.bdb98294.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/72.5b17ac84.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/73.3030d7e2.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/74.3329104a.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/8.c9879746.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/9.684a4798.js"><link rel="prefetch" href="/jiabinxu-blog/assets/js/vendors~docsearch.771dd409.js">
    <link rel="stylesheet" href="/jiabinxu-blog/assets/css/0.styles.6e2e750c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/jiabinxu-blog/" class="home-link router-link-active"><img src="/jiabinxu-blog/R-C.png" alt="è´¾æ»¨æ—­çš„ä¸ªäººæŠ€æœ¯åšå®¢" class="logo"> <span class="site-name can-hide">è´¾æ»¨æ—­çš„ä¸ªäººæŠ€æœ¯åšå®¢</span></a> <div class="links"><div class="search-box"><input aria-label="Search" placeholder="æœç´¢..." autocomplete="off" spellcheck="false" value="" style="background-image:url(/jiabinxu-blog/search.svg);"> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/jiabinxu-blog/Html+Css/" class="nav-link">
  Html+Css
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JavaScript" class="dropdown-title"><span class="title">JavaScript</span> <span class="arrow down"></span></button> <button type="button" aria-label="JavaScript" class="mobile-dropdown-title"><span class="title">JavaScript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/JavaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/JavaScript/handwriting-code/" class="nav-link">
  å¸¸è§é¢è¯•æ‰‹å†™é¢˜
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/JavaScript/scenario-questions/" class="nav-link">
  å¸¸è§é¢è¯•åœºæ™¯é¢˜
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/JavaScript/javascript-core-objects/" class="nav-link">
  JavaScriptæ ¸å¿ƒå¯¹è±¡
</a></li></ul></div></div><div class="nav-item"><a href="/jiabinxu-blog/React/" class="nav-link">
  React
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Hooks" class="dropdown-title"><span class="title">Hooks</span> <span class="arrow down"></span></button> <button type="button" aria-label="Hooks" class="mobile-dropdown-title"><span class="title">Hooks</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useState/" class="nav-link">
  useState
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useEffect/" class="nav-link">
  useEffect
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useRef/" class="nav-link">
  useRef
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useContext/" class="nav-link">
  useContext
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useMemo/" class="nav-link">
  useMemo
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useCallback/" class="nav-link">
  useCallback
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useMemoVSuseCallback/" class="nav-link">
  useMemoVSuseCallback
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useReducer/" class="nav-link">
  useReducer
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useSyncExternalStore/" class="nav-link">
  useSyncExternalStore
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useActionState/" class="nav-link">
  useActionState
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useOptimistic/" class="nav-link">
  useOptimistic
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="é¡¹ç›®å®æˆ˜" class="dropdown-title"><span class="title">é¡¹ç›®å®æˆ˜</span> <span class="arrow down"></span></button> <button type="button" aria-label="é¡¹ç›®å®æˆ˜" class="mobile-dropdown-title"><span class="title">é¡¹ç›®å®æˆ˜</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/nextjs/" class="nav-link">
  nextjs
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/deploy/" class="nav-link">
  å‰ç«¯éƒ¨ç½²
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/fileUpload/" class="nav-link">
  å¤§æ–‡ä»¶ä¸Šä¼ 
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/macOS_Guide/" class="nav-link">
  macOSæŒ‡å—
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/popular-libraries/" class="nav-link">
  å¸¸ç”¨åº“
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/nextjs-i18n/" class="nav-link">
  Next.jså›½é™…åŒ–æ–¹æ¡ˆ
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/nextjs-auth-refresh/" class="nav-link">
  Next.jsåŒtokenæ— æ„Ÿåˆ·æ–°
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/nextjs-dir/" class="nav-link">
  Next.jsç›®å½•æ·±å…¥è§£è¯»
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/flutter-config/" class="nav-link">
  flutterç¯å¢ƒé…ç½®
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/flutter/" class="nav-link">
  flutter
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/chrome-dev-tools/" class="nav-link">
  Chromeè°ƒè¯•å·¥å…·
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/jiabinxu-blog/Html+Css/" class="nav-link">
  Html+Css
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="JavaScript" class="dropdown-title"><span class="title">JavaScript</span> <span class="arrow down"></span></button> <button type="button" aria-label="JavaScript" class="mobile-dropdown-title"><span class="title">JavaScript</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/JavaScript/" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/JavaScript/handwriting-code/" class="nav-link">
  å¸¸è§é¢è¯•æ‰‹å†™é¢˜
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/JavaScript/scenario-questions/" class="nav-link">
  å¸¸è§é¢è¯•åœºæ™¯é¢˜
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/JavaScript/javascript-core-objects/" class="nav-link">
  JavaScriptæ ¸å¿ƒå¯¹è±¡
</a></li></ul></div></div><div class="nav-item"><a href="/jiabinxu-blog/React/" class="nav-link">
  React
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Hooks" class="dropdown-title"><span class="title">Hooks</span> <span class="arrow down"></span></button> <button type="button" aria-label="Hooks" class="mobile-dropdown-title"><span class="title">Hooks</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useState/" class="nav-link">
  useState
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useEffect/" class="nav-link">
  useEffect
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useRef/" class="nav-link">
  useRef
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useContext/" class="nav-link">
  useContext
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useMemo/" class="nav-link">
  useMemo
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useCallback/" class="nav-link">
  useCallback
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useMemoVSuseCallback/" class="nav-link">
  useMemoVSuseCallback
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useReducer/" class="nav-link">
  useReducer
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useSyncExternalStore/" class="nav-link">
  useSyncExternalStore
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useActionState/" class="nav-link">
  useActionState
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/React/Hooks/useOptimistic/" class="nav-link">
  useOptimistic
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="é¡¹ç›®å®æˆ˜" class="dropdown-title"><span class="title">é¡¹ç›®å®æˆ˜</span> <span class="arrow down"></span></button> <button type="button" aria-label="é¡¹ç›®å®æˆ˜" class="mobile-dropdown-title"><span class="title">é¡¹ç›®å®æˆ˜</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/nextjs/" class="nav-link">
  nextjs
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/deploy/" class="nav-link">
  å‰ç«¯éƒ¨ç½²
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/fileUpload/" class="nav-link">
  å¤§æ–‡ä»¶ä¸Šä¼ 
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/macOS_Guide/" class="nav-link">
  macOSæŒ‡å—
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/popular-libraries/" class="nav-link">
  å¸¸ç”¨åº“
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/nextjs-i18n/" class="nav-link">
  Next.jså›½é™…åŒ–æ–¹æ¡ˆ
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/nextjs-auth-refresh/" class="nav-link">
  Next.jsåŒtokenæ— æ„Ÿåˆ·æ–°
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/nextjs-dir/" class="nav-link">
  Next.jsç›®å½•æ·±å…¥è§£è¯»
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/flutter-config/" class="nav-link">
  flutterç¯å¢ƒé…ç½®
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/flutter/" class="nav-link">
  flutter
</a></li><li class="dropdown-item"><!----> <a href="/jiabinxu-blog/project/chrome-dev-tools/" class="nav-link">
  Chromeè°ƒè¯•å·¥å…·
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>åŸºäº Next.js çš„åŒ Token æ— æ„Ÿåˆ·æ–°è®¤è¯ç³»ç»Ÿ - å­¦ä¹ ç¬”è®°</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ğŸš€-æ¦‚è¿°" class="sidebar-link">ğŸš€ æ¦‚è¿°</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬ä¸€éƒ¨åˆ†-åç«¯-api-æ¥å£æ­å»º" class="sidebar-link">ç¬¬ä¸€éƒ¨åˆ†ï¼šåç«¯ API æ¥å£æ­å»º</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬-1-æ­¥-ç”¨æˆ·ç™»å½•æ¥å£-api-auth-login" class="sidebar-link">ç¬¬ 1 æ­¥ï¼šç”¨æˆ·ç™»å½•æ¥å£ (/api/auth/login)</a></li><li class="sidebar-sub-header"><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬-2-æ­¥-åˆ·æ–°-token-æ¥å£-api-auth-refresh" class="sidebar-link">ç¬¬ 2 æ­¥ï¼šåˆ·æ–° Token æ¥å£ (/api/auth/refresh)</a></li><li class="sidebar-sub-header"><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬-3-æ­¥-ç”¨æˆ·ç™»å‡ºæ¥å£-api-auth-logout" class="sidebar-link">ç¬¬ 3 æ­¥ï¼šç”¨æˆ·ç™»å‡ºæ¥å£ (/api/auth/logout)</a></li></ul></li><li><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬äºŒéƒ¨åˆ†-å‰ç«¯è®¤è¯çŠ¶æ€ç®¡ç†-use-client" class="sidebar-link">ç¬¬äºŒéƒ¨åˆ†ï¼šå‰ç«¯è®¤è¯çŠ¶æ€ç®¡ç† (&quot;use client&quot;)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬-4-æ­¥-åˆ›å»ºè®¤è¯ä¸Šä¸‹æ–‡-authcontext" class="sidebar-link">ç¬¬ 4 æ­¥ï¼šåˆ›å»ºè®¤è¯ä¸Šä¸‹æ–‡ (AuthContext)</a></li><li class="sidebar-sub-header"><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬-5-æ­¥-å°è£…è®¤è¯è¯·æ±‚-authfetch" class="sidebar-link">ç¬¬ 5 æ­¥ï¼šå°è£…è®¤è¯è¯·æ±‚ (authFetch)</a></li><li class="sidebar-sub-header"><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬-6-æ­¥-å®ç°æ ¸å¿ƒçš„æ— æ„Ÿåˆ·æ–°é€»è¾‘" class="sidebar-link">ç¬¬ 6 æ­¥ï¼šå®ç°æ ¸å¿ƒçš„æ— æ„Ÿåˆ·æ–°é€»è¾‘</a></li><li class="sidebar-sub-header"><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬-7-æ­¥-å¤„ç†å¹¶å‘è¯·æ±‚-é˜²æ­¢é‡å¤åˆ·æ–°" class="sidebar-link">ç¬¬ 7 æ­¥ï¼šå¤„ç†å¹¶å‘è¯·æ±‚ï¼Œé˜²æ­¢é‡å¤åˆ·æ–°</a></li></ul></li><li><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬ä¸‰éƒ¨åˆ†-æ•´åˆä¸ä½¿ç”¨" class="sidebar-link">ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•´åˆä¸ä½¿ç”¨</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬-8-æ­¥-å…¨å±€åº”ç”¨-provider" class="sidebar-link">ç¬¬ 8 æ­¥ï¼šå…¨å±€åº”ç”¨ Provider</a></li><li class="sidebar-sub-header"><a href="/jiabinxu-blog/project/nextjs-auth-refresh.html#ç¬¬-9-æ­¥-åœ¨ç»„ä»¶ä¸­ä½¿ç”¨" class="sidebar-link">ç¬¬ 9 æ­¥ï¼šåœ¨ç»„ä»¶ä¸­ä½¿ç”¨</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="åŸºäº-next-js-çš„åŒ-token-æ— æ„Ÿåˆ·æ–°è®¤è¯ç³»ç»Ÿ-å­¦ä¹ ç¬”è®°"><a href="#åŸºäº-next-js-çš„åŒ-token-æ— æ„Ÿåˆ·æ–°è®¤è¯ç³»ç»Ÿ-å­¦ä¹ ç¬”è®°" class="header-anchor">#</a> åŸºäº Next.js çš„åŒ Token æ— æ„Ÿåˆ·æ–°è®¤è¯ç³»ç»Ÿ - å­¦ä¹ ç¬”è®°</h1> <h2 id="ğŸš€-æ¦‚è¿°"><a href="#ğŸš€-æ¦‚è¿°" class="header-anchor">#</a> ğŸš€ æ¦‚è¿°</h2> <p>é¦–å…ˆtokenåˆ†ä¸ºä¸¤ç§ä¸€ç§æ˜¯çŸ­æœŸçš„ä¸€ç§æ˜¯é•¿æœŸçš„ï¼Œä¸ºä»€ä¹ˆè¦åˆ†ä¸ºä¸¤ä¸ªtokenå‘¢ï¼Œå°±æ˜¯å› ä¸ºå‡ºäºå®‰å…¨æ€§è€ƒè™‘ï¼Œæ¯”å¦‚è¯´ä½ å•tokenç™»å½•ï¼Œä¸€ä¸ªtokenè¿‡æœŸæ—¶é—´è®¾ç½®ä¸ºå‡ å¤©ï¼Œå¦‚æœè¢«äººè·å–åˆ°äº†è¿™ä¸ªtokenï¼Œåˆ«äººå°±å¯ä»¥åˆ©ç”¨è¿™ä¸ªtokenç™»å½•ç”¨æˆ·çš„è´¦å·ï¼Œè¿™ä¸ªtokenä¹Ÿä¸èƒ½è®¾ç½®çš„å¤ªçŸ­ï¼Œå¦‚æœå¤ªçŸ­çš„è¯ç”¨æˆ·ä½“éªŒå°±å¤ªå·®äº†ï¼Œä½ å»ä¸Šä¸ªå•æ‰€å›æ¥å°±è¦é‡æ–°ç™»å½•äº†</p> <p>å†è¯´å›åŒtokenç™»å½•ï¼ŒçŸ­æœŸtokenå’Œé•¿æœŸtokenï¼ŒçŸ­æœŸtokenä½œä¸ºçœŸæ­£çš„tokenå»ä½¿ç”¨æ‰€æœ‰çš„è¯·æ±‚å¤´éƒ½å¸¦ä¸Šè¿™ä¸ªtokenï¼Œå¦å¤–ä¸€ä¸ªé•¿æœŸtokenä½œä¸ºåˆ·æ–°tokenï¼Œå½“æˆ‘ä»¬çš„çŸ­æœŸtokenè¿‡æœŸçš„æ—¶å€™æˆ‘ä»¬é€šè¿‡è¿™ä¸ªrefreshtokenéªŒè¯æ˜¯å¦çœŸæ­£çš„è¿‡æœŸï¼Œæ²¡æœ‰è¿‡æœŸå°±é‡æ–°ç­¾å‘ä¸€ä¸ªçŸ­æœŸtokenå®ç°æ— æ„Ÿåˆ·æ–°</p> <p>åŒTokenä½“ç³»,<strong>ä¸¤ç§Tokençš„å­˜å‚¨ä½ç½®å’Œæ–¹å¼å®Œå…¨ä¸åŒ</strong>ï¼šçŸ­æœŸtokenå¯ä»¥å­˜åœ¨å†…å­˜ä¸­ï¼Œé•¿æœŸtokenåœ¨æœåŠ¡å™¨ä¸­ï¼ˆæœåŠ¡ç«¯è®¾ç½®çš„ HttpOnly Cookieï¼‰é‡Œï¼Œæ‰€ä»¥å‰ç«¯è·å–ä¸åˆ°è¿™ä¸ªä»£ç ï¼Œå®‰å…¨ç³»æ•°é«˜</p> <ul><li><strong>çŸ­æœŸ accessToken</strong>ï¼šå› ä¸ºå®ƒéœ€è¦è¢«JavaScripté¢‘ç¹è¯»å–å¹¶æ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­ï¼Œæ‰€ä»¥é€šå¸¸å­˜å‚¨åœ¨<strong>å®¢æˆ·ç«¯çš„å†…å­˜</strong>é‡Œï¼ˆæ¯”å¦‚Reactçš„stateæˆ–Vuex/Piniaä¸­ï¼‰ã€‚è¿™ä½¿å¾—å®ƒå®¹æ˜“å—åˆ°XSSæ”»å‡»ï¼Œä½†å› ä¸ºå®ƒç”Ÿå‘½å‘¨æœŸæçŸ­ï¼Œè¢«ç›—åçš„å±å®³æœ‰é™ã€‚</li> <li><strong>é•¿æœŸ refreshToken</strong>ï¼šå®ƒçš„å®‰å…¨æ€§æœ€é«˜ã€‚æœ€ä½³å®è·µæ˜¯å°†å…¶å­˜å‚¨åœ¨ç”±<strong>æœåŠ¡ç«¯è®¾ç½®çš„ HttpOnly Cookie</strong> ä¸­ã€‚
<ul><li><code>HttpOnly</code> å±æ€§æ„å‘³ç€å‰ç«¯çš„JavaScriptä»£ç <strong>å®Œå…¨æ— æ³•è¯»å–</strong>åˆ°è¿™ä¸ªCookieã€‚</li> <li>è¿™æ ·ä¸€æ¥ï¼Œå³ä½¿ç½‘ç«™é­åˆ°XSSæ”»å‡»ï¼Œæ”»å‡»è€…çš„è„šæœ¬ä¹Ÿå·ä¸èµ° <code>refreshToken</code>ï¼Œä»è€Œä¿è¯äº†ç”¨æˆ·é•¿æœŸä¼šè¯çš„å®‰å…¨ã€‚</li></ul></li></ul> <p>å¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼š<a href="#%E7%AC%AC-7-%E6%AD%A5-%E5%A4%84%E7%90%86%E5%B9%B6%E5%8F%91%E8%AF%B7%E6%B1%82-%E9%98%B2%E6%AD%A2%E9%87%8D%E5%A4%8D%E5%88%B7%E6%96%B0">å¦‚æœå¤šä¸ªè¯·æ±‚åŒæ—¶å› ä¸º Token è¿‡æœŸè€Œå¤±è´¥ï¼Œå®ƒä»¬ä¼šåŒæ—¶è§¦å‘åˆ·æ–°ï¼Œé€ æˆæµªè´¹å’Œå†²çªã€‚</a></p> <h2 id="ç¬¬ä¸€éƒ¨åˆ†-åç«¯-api-æ¥å£æ­å»º"><a href="#ç¬¬ä¸€éƒ¨åˆ†-åç«¯-api-æ¥å£æ­å»º" class="header-anchor">#</a> ç¬¬ä¸€éƒ¨åˆ†ï¼šåç«¯ API æ¥å£æ­å»º</h2> <p>æˆ‘ä»¬åœ¨ Next.js çš„ App Router ä¸­åˆ›å»ºä¸‰ä¸ªæ ¸å¿ƒçš„ API æ¥å£ï¼Œç”¨äºå¤„ç†è®¤è¯æµç¨‹ã€‚</p> <h3 id="ç¬¬-1-æ­¥-ç”¨æˆ·ç™»å½•æ¥å£-api-auth-login"><a href="#ç¬¬-1-æ­¥-ç”¨æˆ·ç™»å½•æ¥å£-api-auth-login" class="header-anchor">#</a> ç¬¬ 1 æ­¥ï¼šç”¨æˆ·ç™»å½•æ¥å£ (<code>/api/auth/login</code>)</h3> <p><strong>ç›®çš„</strong>ï¼šéªŒè¯ç”¨æˆ·èº«ä»½ï¼ŒæˆåŠŸåè¿”å› <code>accessToken</code>ï¼ŒåŒæ—¶å°† <code>refreshToken</code> å®‰å…¨åœ°è®¾ç½®åœ¨ <code>HttpOnly</code> Cookie ä¸­ã€‚</p> <h4 id="_1-1-ç­¾å‘ä¸¤ç§-token"><a href="#_1-1-ç­¾å‘ä¸¤ç§-token" class="header-anchor">#</a> 1.1 - ç­¾å‘ä¸¤ç§ Token</h4> <div class="language- extra-class"><pre class="language-text"><code>// æ–‡ä»¶: /app/api/auth/login/route.ts
import { sign } from 'jsonwebtoken';

// å‡è®¾ç”¨æˆ·éªŒè¯æˆåŠŸï¼Œç”¨æˆ·IDä¸º 1
const userId = 1;
const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';

// åˆ›å»º AccessToken (æœ‰æ•ˆæœŸçŸ­ï¼Œä¾‹å¦‚15åˆ†é’Ÿ)
const accessToken = sign({ userId }, JWT_SECRET, { expiresIn: '15m' });
// åˆ›å»º RefreshToken (æœ‰æ•ˆæœŸé•¿ï¼Œä¾‹å¦‚7å¤©)
const refreshToken = sign({ userId }, JWT_SECRET, { expiresIn: '7d' });
</code></pre></div><h4 id="_1-2-å°†-refreshtoken-åºåˆ—åŒ–ä¸ºå®‰å…¨çš„-cookie"><a href="#_1-2-å°†-refreshtoken-åºåˆ—åŒ–ä¸ºå®‰å…¨çš„-cookie" class="header-anchor">#</a> 1.2 - å°† RefreshToken åºåˆ—åŒ–ä¸ºå®‰å…¨çš„ Cookie</h4> <div class="language- extra-class"><pre class="language-text"><code>// æ–‡ä»¶: /app/api/auth/login/route.ts
import { serialize } from 'cookie';

const serializedCookie = serialize('refreshToken', refreshToken, {
    httpOnly: true, // é˜²æ­¢JSè¯»å–ï¼Œé˜²å¾¡XSSæ”»å‡»
    secure: process.env.NODE_ENV === 'production', // åªåœ¨HTTPSä¸‹ä¼ è¾“
    sameSite: 'strict', // ä¸¥æ ¼çš„åŒç«™ç­–ç•¥ï¼Œé˜²å¾¡CSRFæ”»å‡»
    maxAge: 60 * 60 * 24 * 7, // 7å¤©æœ‰æ•ˆæœŸ
    path: '/',
});
</code></pre></div><h4 id="_1-3-ç»„åˆæˆå®Œæ•´æ¥å£"><a href="#_1-3-ç»„åˆæˆå®Œæ•´æ¥å£" class="header-anchor">#</a> 1.3 - ç»„åˆæˆå®Œæ•´æ¥å£</h4> <div class="language- extra-class"><pre class="language-text"><code>// æ–‡ä»¶: /app/api/auth/login/route.ts
import { NextResponse } from 'next/server';

export async function POST(req: Request) {
    // ... ç”¨æˆ·åå¯†ç éªŒè¯é€»è¾‘ ...
    // ... ç­¾å‘ token å’Œåºåˆ—åŒ– cookie çš„ä»£ç  ...
    
    return NextResponse.json(
        { accessToken }, // åœ¨bodyä¸­è¿”å›accessToken
        {
            status: 200,
            headers: { 'Set-Cookie': serializedCookie }, // åœ¨headerä¸­è®¾ç½®cookie
        }
    );
}
</code></pre></div><blockquote><p>ğŸ’¡ <strong>æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾</strong></p> <ul><li><strong>jsonwebtoken</strong>: è¿™æ˜¯ä¸€ä¸ªæ„å»ºå’ŒéªŒè¯â€œæ•°å­—èº«ä»½è¯â€ï¼ˆJWTï¼‰çš„å·¥å…·ã€‚
<ul><li><code>jwt.sign()</code>: <strong>ç­¾å‘å‡­è¯</strong>ã€‚å®ƒæ¥æ”¶ç”¨æˆ·ä¿¡æ¯ï¼ˆPayloadï¼‰ã€ä¸€ä¸ªç»å¯†çš„ç§˜é’¥ï¼ˆSecret Keyï¼‰ï¼Œç”Ÿæˆä¸€ä¸ªå¸¦é˜²ä¼ªç­¾åï¼ˆSignatureï¼‰çš„ Token å­—ç¬¦ä¸²ã€‚è¿™ç¡®ä¿äº† Token çš„å†…å®¹æœªç»ç¯¡æ”¹ã€‚</li> <li><code>jwt.verify()</code>: <strong>éªŒè¯å‡­è¯</strong>ã€‚å®ƒä½¿ç”¨<strong>åŒä¸€ä¸ªç§˜é’¥</strong>æ¥æ£€æŸ¥ Token çš„ç­¾åæ˜¯å¦æ­£ç¡®ã€æ˜¯å¦åœ¨æœ‰æ•ˆæœŸå†…ã€‚è¿™æ˜¯å®ç°<strong>æ— çŠ¶æ€è®¤è¯</strong>çš„å…³é”®ï¼ŒæœåŠ¡å™¨æ— éœ€å­˜å‚¨ Session ä¿¡æ¯ã€‚</li></ul></li> <li><strong>NextResponse.json()</strong>: è¿™ä¸æ˜¯ç®€å•çš„ <code>JSON.stringify()</code>ã€‚å®ƒæ˜¯ä¸€ä¸ª<strong>å®Œæ•´çš„ HTTP å“åº”æ„é€ å™¨</strong>ã€‚
<ul><li>å®ƒå°† JS å¯¹è±¡è½¬æ¢ä¸º JSON å­—ç¬¦ä¸²ä½œä¸º<strong>å“åº”ä½“ (Body)</strong>ã€‚</li> <li><strong>è‡ªåŠ¨è®¾ç½®</strong>å…³é”®çš„ <code>Content-Type: application/json</code> <strong>å“åº”å¤´ (Header)</strong>ï¼Œå‘ŠçŸ¥æµè§ˆå™¨æ•°æ®æ ¼å¼ã€‚</li> <li>å®ƒè¿”å›ä¸€ä¸ªåŠŸèƒ½é½å…¨çš„ <code>NextResponse</code> å¯¹è±¡ï¼Œå…è®¸ä½ é“¾å¼åœ°è®¾ç½®çŠ¶æ€ç ã€Cookie (<code>Set-Cookie</code>) å’Œå…¶ä»–è‡ªå®šä¹‰ Headersï¼Œæ˜¯æ„å»ºå¥å£®åç«¯ API çš„åŸºçŸ³ã€‚</li></ul></li></ul></blockquote> <h3 id="ç¬¬-2-æ­¥-åˆ·æ–°-token-æ¥å£-api-auth-refresh"><a href="#ç¬¬-2-æ­¥-åˆ·æ–°-token-æ¥å£-api-auth-refresh" class="header-anchor">#</a> ç¬¬ 2 æ­¥ï¼šåˆ·æ–° Token æ¥å£ (<code>/api/auth/refresh</code>)</h3> <p><strong>ç›®çš„</strong>ï¼šå½“ <code>accessToken</code> è¿‡æœŸæ—¶ï¼Œå‰ç«¯è°ƒç”¨æ­¤æ¥å£ï¼ŒéªŒè¯ <code>refreshToken</code> Cookieï¼Œå¹¶è¿”å›ä¸€ä¸ªæ–°çš„ <code>accessToken</code>ã€‚</p> <h4 id="_2-1-è¯»å–å¹¶éªŒè¯-cookie"><a href="#_2-1-è¯»å–å¹¶éªŒè¯-cookie" class="header-anchor">#</a> 2.1 - è¯»å–å¹¶éªŒè¯ Cookie</h4> <div class="language- extra-class"><pre class="language-text"><code>// æ–‡ä»¶: /app/api/auth/refresh/route.ts
import { cookies } from 'next/headers';
import { verify } from 'jsonwebtoken';

const JWT_SECRET = process.env.JWT_SECRET || 'your-secret-key';

export async function POST(req: Request) {
    const cookieStore = cookies();
    const refreshToken = cookieStore.get('refreshToken')?.value;

    if (!refreshToken) {
        return NextResponse.json({ message: 'RefreshToken æœªæ‰¾åˆ°' }, { status: 401 });
    }

    try {
        const decoded = verify(refreshToken, JWT_SECRET) as { userId: number };
        // ... æ¥ 2.2
    } catch (error) {
        return NextResponse.json({ message: 'ä¼šè¯æ— æ•ˆï¼Œè¯·é‡æ–°ç™»å½•' }, { status: 401 });
    }
}
</code></pre></div><h4 id="_2-2-ç­¾å‘æ–°çš„-accesstoken"><a href="#_2-2-ç­¾å‘æ–°çš„-accesstoken" class="header-anchor">#</a> 2.2 - ç­¾å‘æ–°çš„ AccessToken</h4> <div class="language- extra-class"><pre class="language-text"><code>// æ–‡ä»¶: /app/api/auth/refresh/route.ts
// ... (åœ¨ try å—å†…éƒ¨)
// ä½¿ç”¨ä» refreshToken è§£ç å‡ºçš„ç”¨æˆ·ä¿¡æ¯æ¥åˆ›å»ºæ–°çš„ accessToken
const accessToken = sign({ userId: decoded.userId }, JWT_SECRET, { expiresIn: '15m' });
return NextResponse.json({ accessToken });
</code></pre></div><h3 id="ç¬¬-3-æ­¥-ç”¨æˆ·ç™»å‡ºæ¥å£-api-auth-logout"><a href="#ç¬¬-3-æ­¥-ç”¨æˆ·ç™»å‡ºæ¥å£-api-auth-logout" class="header-anchor">#</a> ç¬¬ 3 æ­¥ï¼šç”¨æˆ·ç™»å‡ºæ¥å£ (<code>/api/auth/logout</code>)</h3> <p><strong>ç›®çš„</strong>ï¼šè®© <code>refreshToken</code> Cookie å¤±æ•ˆï¼Œå®Œæˆç™»å‡ºã€‚é€šè¿‡è¿”å›ä¸€ä¸ªåŒåã€åŒè·¯å¾„ä½† <code>maxAge</code> ä¸ºè´Ÿæ•°çš„ Cookie å®ç°ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>// æ–‡ä»¶: /app/api/auth/logout/route.ts
import { NextResponse } from 'next/server';
import { serialize } from 'cookie';

export async function POST(req: Request) {
    const serializedCookie = serialize('refreshToken', '', {
        httpOnly: true,
        secure: process.env.NODE_ENV === 'production',
        sameSite: 'strict',
        path: '/',
        maxAge: -1, // å…³é”®ï¼šè®¾ç½®ä¸ºè´Ÿæ•°ä½¿å…¶ç«‹å³è¿‡æœŸ
    });

    return NextResponse.json(
        { message: 'ç™»å‡ºæˆåŠŸ' },
        {
            status: 200,
            headers: { 'Set-Cookie': serializedCookie },
        }
    );
}
</code></pre></div><h2 id="ç¬¬äºŒéƒ¨åˆ†-å‰ç«¯è®¤è¯çŠ¶æ€ç®¡ç†-use-client"><a href="#ç¬¬äºŒéƒ¨åˆ†-å‰ç«¯è®¤è¯çŠ¶æ€ç®¡ç†-use-client" class="header-anchor">#</a> ç¬¬äºŒéƒ¨åˆ†ï¼šå‰ç«¯è®¤è¯çŠ¶æ€ç®¡ç† (<code>&quot;use client&quot;</code>)</h2> <h3 id="ç¬¬-4-æ­¥-åˆ›å»ºè®¤è¯ä¸Šä¸‹æ–‡-authcontext"><a href="#ç¬¬-4-æ­¥-åˆ›å»ºè®¤è¯ä¸Šä¸‹æ–‡-authcontext" class="header-anchor">#</a> ç¬¬ 4 æ­¥ï¼šåˆ›å»ºè®¤è¯ä¸Šä¸‹æ–‡ (AuthContext)</h3> <p><strong>ç›®çš„</strong>ï¼šåˆ›å»ºä¸€ä¸ªå…¨å±€çŠ¶æ€ç®¡ç†å™¨ï¼Œè®©åº”ç”¨ä¸­ä»»ä½•ç»„ä»¶éƒ½èƒ½æ–¹ä¾¿åœ°è·å–è®¤è¯çŠ¶æ€å’Œæ–¹æ³•ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>// æ–‡ä»¶: /app/contexts/AuthContext.tsx
&quot;use client&quot;;
import React, { createContext, useContext, useState, ReactNode } from 'react';

// ... (æ¥å£å®šä¹‰å’Œ Provider/Hook éª¨æ¶)
</code></pre></div><h3 id="ç¬¬-5-æ­¥-å°è£…è®¤è¯è¯·æ±‚-authfetch"><a href="#ç¬¬-5-æ­¥-å°è£…è®¤è¯è¯·æ±‚-authfetch" class="header-anchor">#</a> ç¬¬ 5 æ­¥ï¼šå°è£…è®¤è¯è¯·æ±‚ (<code>authFetch</code>)</h3> <p><strong>ç›®çš„</strong>ï¼šåˆ›å»ºä¸€ä¸ª <code>fetch</code> çš„æ›¿ä»£å“ï¼Œå®ƒèƒ½è‡ªåŠ¨ä¸ºè¯·æ±‚æ·»åŠ  <code>Authorization</code> å¤´ï¼Œå¹¶å¤„ç†åç»­çš„æ— æ„Ÿåˆ·æ–°ã€‚</p> <h3 id="ç¬¬-6-æ­¥-å®ç°æ ¸å¿ƒçš„æ— æ„Ÿåˆ·æ–°é€»è¾‘"><a href="#ç¬¬-6-æ­¥-å®ç°æ ¸å¿ƒçš„æ— æ„Ÿåˆ·æ–°é€»è¾‘" class="header-anchor">#</a> ç¬¬ 6 æ­¥ï¼šå®ç°æ ¸å¿ƒçš„æ— æ„Ÿåˆ·æ–°é€»è¾‘</h3> <p>åœ¨ <code>authFetch</code> å†…éƒ¨æ•è· 401 é”™è¯¯ï¼Œè°ƒç”¨åˆ·æ–° APIï¼Œè·å–æ–°çš„ <code>accessToken</code>ï¼Œç„¶åç”¨æ–° Token <strong>é‡è¯•</strong>åˆšæ‰å¤±è´¥çš„è¯·æ±‚ã€‚</p> <h3 id="ç¬¬-7-æ­¥-å¤„ç†å¹¶å‘è¯·æ±‚-é˜²æ­¢é‡å¤åˆ·æ–°"><a href="#ç¬¬-7-æ­¥-å¤„ç†å¹¶å‘è¯·æ±‚-é˜²æ­¢é‡å¤åˆ·æ–°" class="header-anchor">#</a> ç¬¬ 7 æ­¥ï¼šå¤„ç†å¹¶å‘è¯·æ±‚ï¼Œé˜²æ­¢é‡å¤åˆ·æ–°</h3> <p>é—®é¢˜ï¼šå¦‚æœå¤šä¸ªè¯·æ±‚åŒæ—¶å› ä¸º Token è¿‡æœŸè€Œå¤±è´¥ï¼Œå®ƒä»¬ä¼šåŒæ—¶è§¦å‘åˆ·æ–°ï¼Œé€ æˆæµªè´¹å’Œå†²çªã€‚</p> <p>è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ä¸€ä¸ªå¤–éƒ¨å˜é‡ä½œä¸ºâ€œé”â€ï¼Œç¡®ä¿åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªåˆ·æ–°è¯·æ±‚åœ¨è¿›è¡Œã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>// æ–‡ä»¶: /app/contexts/AuthContext.tsx

// åœ¨ AuthProvider ç»„ä»¶å¤–éƒ¨å®šä¹‰ä¸€ä¸ªå˜é‡
let refreshTokenPromise: Promise&lt;string | null&gt; | null = null;

// åœ¨ AuthProvider å†…éƒ¨ï¼ŒauthFetch çš„ 401 å¤„ç†é€»è¾‘
if (response.status === 401) {
    if (!refreshTokenPromise) {
        // å¦‚æœå½“å‰æ²¡æœ‰æ­£åœ¨åˆ·æ–°çš„è¯·æ±‚ï¼Œåˆ™å‘èµ·ä¸€ä¸ªæ–°çš„
        refreshTokenPromise = new Promise(async (resolve, reject) =&gt; {
            try {
                // ... (æ‰§è¡Œåˆ·æ–°Tokençš„APIè°ƒç”¨) ...
                const newAccessToken = '...';
                resolve(newAccessToken);
            } catch (e) {
                reject(e);
            } finally {
                // ç»“æŸåï¼Œæ¸…ç©ºPromiseï¼Œä»¥ä¾¿ä¸‹æ¬¡å¯ä»¥å†æ¬¡è§¦å‘
                refreshTokenPromise = null;
            }
        });
    }

    try {
        // ç­‰å¾…æ­£åœ¨è¿›è¡Œçš„åˆ·æ–°è¯·æ±‚å®Œæˆ
        const newAccessToken = await refreshTokenPromise;
        // ... (ç”¨ newAccessToken é‡è¯•è¯·æ±‚) ...
    } catch (e) {
        // åˆ·æ–°å¤±è´¥ï¼Œç™»å‡º
    }
}
</code></pre></div><blockquote><p>ğŸ§  <strong>æ·±åº¦è§£æï¼šå¹¶å‘åˆ·æ–°ä¸ Promise é”æ¨¡å¼</strong></p> <p>è¿™æ˜¯ä¸€ä¸ªæå…¶å·§å¦™çš„å¹¶å‘æ§åˆ¶æ¨¡å¼ã€‚ä¸ºä»€ä¹ˆå¿…é¡»ç”¨ <code>Promise</code> è€Œä¸æ˜¯ç®€å•çš„å¸ƒå°”å€¼ <code>isRefreshing</code>ï¼Ÿ</p> <ul><li><strong>å¸ƒå°”å€¼çš„ç¼ºé™·</strong>: å¸ƒå°”å€¼åªèƒ½å‘ŠçŸ¥â€œ<strong>æ˜¯å¦åœ¨åˆ·æ–°</strong>â€ï¼Œä½†å®ƒæ— æ³•æä¾›ä¸€ä¸ªæœºåˆ¶è®©åæ¥çš„è¯·æ±‚<strong>æš‚åœå¹¶ç­‰å¾…ç»“æœ</strong>ï¼Œä¹Ÿæ— æ³•<strong>ä¼ é€’æœ€ç»ˆçš„ç»“æœ</strong>ï¼ˆæ–°çš„Tokenï¼‰ã€‚ç®€å•çš„ <code>while(isRefreshing)</code> ä¼šé˜»å¡ JavaScript ä¸»çº¿ç¨‹ï¼Œå¯¼è‡´é¡µé¢å¡æ­»ã€‚</li> <li><strong>Promise çš„å®Œç¾ Ã§Ã¶zÃ¼m</strong>ï¼š
<ol><li><strong>çŠ¶æ€å³æ˜¯é”</strong>: ä¸€ä¸ªå¤„äº <code>pending</code> çŠ¶æ€çš„ Promise æœ¬èº«å°±æ˜¯ä¸€ä¸ªå®Œç¾çš„â€œé”â€ã€‚</li> <li><strong>await å³æ˜¯ç­‰å¾…</strong>: <code>await</code> å…³é”®å­—å¤©ç”Ÿå°±æ˜¯ç”¨æ¥â€œæš‚åœâ€å½“å‰å‡½æ•°ï¼Œç­‰å¾…ä¸€ä¸ª Promise å®Œæˆï¼Œå¹¶ä¸”<strong>ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹</strong>ã€‚</li> <li><strong>resolve å³æ˜¯ç»“æœä¼ é€’</strong>: å½“ Promise è¢« <code>resolve(value)</code> æ—¶ï¼Œæ‰€æœ‰ <code>await</code> è¿™ä¸ª Promise çš„åœ°æ–¹éƒ½ä¼šè¢«å”¤é†’ï¼Œå¹¶æ‹¿åˆ°è¿™ä¸ª <code>value</code>ã€‚</li></ol></li></ul> <blockquote><p>æ€æƒ³å‡åï¼šå‘å¸ƒ-è®¢é˜…æ¨¡å¼çš„ç²¾å¦™åº”ç”¨</p></blockquote> <blockquote><p>è¿™ä¸ª Promise é”æ¨¡å¼ï¼Œæœ¬è´¨ä¸Šæ˜¯<strong>åˆ©ç”¨ Promise çš„åŸç”Ÿç‰¹æ€§ï¼Œå®ç°äº†ä¸€æ¬¡æ€§çš„ã€å¸¦è®°å¿†åŠŸèƒ½çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼</strong>ã€‚</p></blockquote> <blockquote><ul><li><strong>ä¸»é¢˜</strong>: <code>refreshTokenPromise</code> è¿™ä¸ª Promise å¯¹è±¡ã€‚</li> <li><strong>å‘å¸ƒè€…</strong>: ç¬¬ä¸€ä¸ªè§¦å‘åˆ·æ–°å¹¶åˆ›å»º <code>new Promise</code> çš„è¯·æ±‚ã€‚å®ƒé€šè¿‡è°ƒç”¨ <code>resolve</code> æˆ– <code>reject</code> æ¥â€œå‘å¸ƒâ€æœ€ç»ˆç»“æœã€‚</li> <li><strong>è®¢é˜…è€…</strong>: æ‰€æœ‰åæ¥ <code>await refreshTokenPromise</code> çš„è¯·æ±‚ã€‚å®ƒä»¬â€œè®¢é˜…â€äº†è¿™ä¸ªä¸»é¢˜ï¼Œç­‰å¾…æœ€ç»ˆç»“æœçš„é€šçŸ¥ã€‚</li></ul></blockquote> <blockquote><p>è¿™è¯æ˜äº†<strong>è®¾è®¡æ¨¡å¼æ˜¯ä¸€ç§æ€æƒ³ï¼Œè€Œéå›ºå®šçš„ä»£ç </strong>ã€‚é€šè¿‡ç†è§£å…¶æ ¸å¿ƒï¼ˆå¦‚è§£è€¦ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å„ç§å·¥å…·ï¼ˆå¦‚ Promiseï¼‰å·§å¦™åœ°å®ç°å®ƒã€‚</p></blockquote></blockquote> <h2 id="ç¬¬ä¸‰éƒ¨åˆ†-æ•´åˆä¸ä½¿ç”¨"><a href="#ç¬¬ä¸‰éƒ¨åˆ†-æ•´åˆä¸ä½¿ç”¨" class="header-anchor">#</a> ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ•´åˆä¸ä½¿ç”¨</h2> <h3 id="ç¬¬-8-æ­¥-å…¨å±€åº”ç”¨-provider"><a href="#ç¬¬-8-æ­¥-å…¨å±€åº”ç”¨-provider" class="header-anchor">#</a> ç¬¬ 8 æ­¥ï¼šå…¨å±€åº”ç”¨ Provider</h3> <p>å°† <code>AuthProvider</code> åŒ…è£¹åœ¨æ ¹å¸ƒå±€ <code>layout.tsx</code> ä¸­ï¼Œä½¿æ•´ä¸ªåº”ç”¨éƒ½èƒ½è®¿é—®åˆ°è®¤è¯çŠ¶æ€ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>// æ–‡ä»¶: /app/layout.tsx
import { AuthProvider } from './contexts/AuthContext';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    &lt;html lang=&quot;en&quot;&gt;
      &lt;body&gt;
        &lt;AuthProvider&gt;
          {children}
        &lt;/AuthProvider&gt;
      &lt;/body&gt;
    &lt;/html&gt;
  );
}

</code></pre></div><h3 id="ç¬¬-9-æ­¥-åœ¨ç»„ä»¶ä¸­ä½¿ç”¨"><a href="#ç¬¬-9-æ­¥-åœ¨ç»„ä»¶ä¸­ä½¿ç”¨" class="header-anchor">#</a> ç¬¬ 9 æ­¥ï¼šåœ¨ç»„ä»¶ä¸­ä½¿ç”¨</h3> <p>åœ¨ä»»ä½•å®¢æˆ·ç«¯ç»„ä»¶ä¸­ï¼Œé€šè¿‡ <code>useAuth</code> hook æ¥è·å–æ•°æ®æˆ–æ‰§è¡Œæ“ä½œã€‚<code>authFetch</code> ä¼šåœ¨åå°è‡ªåŠ¨å¤„ç†æ‰€æœ‰ Token åˆ·æ–°é€»è¾‘ï¼Œå®ç°çœŸæ­£çš„â€œæ— æ„Ÿåˆ·æ–°â€ã€‚</p> <div class="language- extra-class"><pre class="language-text"><code>// æ–‡ä»¶: /app/dashboard/page.tsx
&quot;use client&quot;;
import { useAuth } from &quot;../contexts/AuthContext&quot;;
import { useEffect } from &quot;react&quot;;

export default function Dashboard() {
    const { authFetch, logout } = useAuth();

    useEffect(() =&gt; {
        const loadData = async () =&gt; {
            try {
                // ä½¿ç”¨æˆ‘ä»¬å°è£…å¥½çš„ authFetchï¼Œå®ƒä¼šè‡ªåŠ¨å¤„ç†è®¤è¯å’Œåˆ·æ–°
                const res = await authFetch('/api/some-protected-data');
                const data = await res.json();
                console.log(data);
            } catch (error) {
                // åˆ·æ–°å¤±è´¥çš„é”™è¯¯ä¼šåœ¨è¿™é‡Œè¢«æ•è·
                console.error(error);
            }
        };
        loadData();
    }, [authFetch]);

    return &lt;button onClick={logout}&gt;ç™»å‡º&lt;/button&gt;;
}

</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/jiabinxu-blog/assets/js/app.f81cf313.js" defer></script><script src="/jiabinxu-blog/assets/js/3.bb87b8ff.js" defer></script><script src="/jiabinxu-blog/assets/js/2.180c3171.js" defer></script><script src="/jiabinxu-blog/assets/js/70.d4fc17a1.js" defer></script>
  </body>
</html>
