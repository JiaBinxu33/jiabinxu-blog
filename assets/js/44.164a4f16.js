(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{366:function(_,v,t){"use strict";t.r(v);var s=t(27),e=Object(s.a)({},(function(){var _=this,v=_._self._c;return v("ContentSlotsDistributor",{attrs:{"slot-key":_.$parent.slotKey}},[v("h1",{attrs:{id:"useoptimistic"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#useoptimistic"}},[_._v("#")]),_._v(" useOptimistic")]),_._v(" "),v("h2",{attrs:{id:"_1-它是什么"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_1-它是什么"}},[_._v("#")]),_._v(" 1. 它是什么？")]),_._v(" "),v("p",[v("code",[_._v("useOptimistic")]),_._v(" 是一个 React19 新加入的 Hooks，它允许您在执行"),v("strong",[_._v("异步")]),_._v("操作（如网络请求）时，"),v("strong",[_._v("立即")]),_._v("向用户展示一个“乐观”的 UI 状态。")]),_._v(" "),v("p",[_._v("它"),v("strong",[_._v("乐观地假设您的操作一定会成功")]),_._v("，从而在“等待”的 2 秒钟内，让 UI 感觉“零延迟”。")]),_._v(" "),v("h2",{attrs:{id:"_2-为什么需要它"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_2-为什么需要它"}},[_._v("#")]),_._v(" 2. 为什么需要它？")]),_._v(" "),v("p",[_._v("这是为了解决 UI 的"),v("strong",[_._v("滞后感")]),_._v("。")]),_._v(" "),v("ul",[v("li",[v("p",[v("strong",[_._v("没有乐观更新（“悲观”模式）：")])]),_._v(" "),v("ol",[v("li",[_._v("用户点击“发送”按钮。")]),_._v(" "),v("li",[_._v("UI 显示“加载中...”")]),_._v(" "),v("li",[_._v("等待 2 秒...")]),_._v(" "),v("li",[_._v("服务器返回成功。")]),_._v(" "),v("li",[_._v("UI 才显示“发送成功”。")])]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("体验：")]),_._v(" 缓慢，卡顿。")])])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("使用乐观更新")])]),_._v(" "),v("ol",[v("li",[_._v("用户点击“发送”按钮。")]),_._v(" "),v("li",[_._v("UI "),v("strong",[_._v("立即")]),_._v("显示“发送成功”的状态（这是“假”的乐观状态）。")]),_._v(" "),v("li",[v("strong",[_._v("同时")]),_._v("，网络请求在后台"),v("strong",[_._v("悄悄")]),_._v("开始。")]),_._v(" "),v("li",[_._v("等待 2 秒...")]),_._v(" "),v("li",[_._v("服务器返回成功。UI 保持不变（因为我们猜对了）。")])]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("体验：")]),_._v(" 极度流畅，操作得到了“即时反馈”。")])])])]),_._v(" "),v("p",[v("code",[_._v("useOptimistic")]),_._v(" 的作用，就是"),v("strong",[_._v("用一个 Hook 来自动管理这个“猜”和“猜错后回滚”的复杂逻辑")]),_._v("。")]),_._v(" "),v("hr"),_._v(" "),v("h2",{attrs:{id:"_3-hook-签名与详解"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_3-hook-签名与详解"}},[_._v("#")]),_._v(" 3. Hook 签名与详解")]),_._v(" "),v("p",[_._v("这是 "),v("code",[_._v("useOptimistic")]),_._v(" 的标准用法：")]),_._v(" "),v("p",[_._v("TypeScript")]),_._v(" "),v("div",{staticClass:"language- extra-class"},[v("pre",{pre:!0,attrs:{class:"language-text"}},[v("code",[_._v('const [optimisticState, addOptimistic] = useOptimistic(\n  realState,    // 参数 1: "真实状态" (安全网)\n  updateFn      // 参数 2: "更新配方" (说明书)\n);\n')])])]),v("p",[_._v("现在，我们来详细分解您问的每一个部分。")]),_._v(" "),v("h3",{attrs:{id:"参数-1-realstate-例如-realmessages-安全网"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#参数-1-realstate-例如-realmessages-安全网"}},[_._v("#")]),_._v(" 参数 1："),v("code",[_._v("realState")]),_._v(" (例如："),v("code",[_._v("realMessages")]),_._v(") - “安全网”")]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("它是什么？")]),_._v(" 这是您的**“事实来源” (Source of Truth)"),v("strong",[_._v("。它通常是您从 useState 或 useReducer 中获得的")]),_._v("“真实”**状态。它代表了 100% 已被服务器“确认”的数据。")]),_._v(" "),v("li",[v("strong",[_._v("它的用法 (关键！)：")]),_._v(" "),v("code",[_._v("useOptimistic")]),_._v(" 会在"),v("strong",[_._v("两个")]),_._v("时刻"),v("strong",[_._v("自动")]),_._v("使用它：\n"),v("ol",[v("li",[v("strong",[_._v("作为“回滚”的目标 (如果失败)：")]),_._v(" 这是 "),v("code",[_._v("useOptimistic")]),_._v(" 最神奇的地方。如果您的异步 "),v("code",[_._v("action")]),_._v(" "),v("strong",[_._v("失败")]),_._v("了（比如 "),v("code",[_._v("throw new Error()")]),_._v("），React 会"),v("strong",[_._v("自动")]),_._v("捕获这个失败，然后"),v("strong",[_._v("立即")]),_._v("把 "),v("code",[_._v("optimisticState")]),_._v(" "),v("strong",[_._v("“回滚”")]),_._v(" 到 "),v("code",[_._v("realState")]),_._v(" 的状态。")]),_._v(" "),v("li",[v("strong",[_._v("作为“提交”的基础 (如果成功)：")]),_._v(" 当您的 "),v("code",[_._v("action")]),_._v(" "),v("strong",[_._v("成功")]),_._v("后，您会（在 "),v("code",[_._v("try")]),_._v(" 块中）调用 "),v("code",[_._v("setRealMessages(...)")]),_._v(" 来更新这个“真实状态”。当 "),v("code",[_._v("useOptimistic")]),_._v(" 侦测到 "),v("code",[_._v("realState")]),_._v(" 发生变化时，它就知道“乐观的更新‘转正’了”，它会自动用这个新的“真实”状态来替换掉“乐观”状态。")])])])]),_._v(" "),v("h3",{attrs:{id:"参数-2-updatefn-currentstate-optimisticvalue-更新配方"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#参数-2-updatefn-currentstate-optimisticvalue-更新配方"}},[_._v("#")]),_._v(" 参数 2："),v("code",[_._v("updateFn(currentState, optimisticValue)")]),_._v(" - “更新配方”")]),_._v(" "),v("ul",[v("li",[v("p",[v("strong",[_._v("它是什么？")]),_._v(" 它是一个"),v("strong",[_._v("函数")]),_._v("，您用来定义 "),v("code",[_._v("addOptimistic")]),_._v(" (返回值) 具体应该怎么做的，调用 "),v("code",[_._v("addOptimistic(newValue)")]),_._v(" 时\nReact 会"),v("strong",[_._v("立即")]),_._v("执行这个函数")]),_._v(" "),v("ol",[v("li",[v("strong",[_._v("currentState")]),_._v(" (由 React 传入)：这是**“当前”"),v("strong",[_._v("的状态。这可能是 realState（如果是第一次乐观更新），也可能是")]),_._v("上一个**乐观状态（如果您连续快速地添加了多条消息）。")]),_._v(" "),v("li",[v("strong",[_._v("optimisticValue")]),_._v(" (由 React 传入)：这就是您调用 "),v("code",[_._v("addOptimistic( ... )")]),_._v(" 时"),v("strong",[_._v("传入的那个值")]),_._v("。")])]),_._v(" "),v("p",[_._v("您"),v("strong",[_._v("必须")]),_._v("在这个函数中"),v("strong",[_._v("返回")]),_._v("您希望 UI "),v("strong",[_._v("立即")]),_._v("展示的**“新乐观状态”**。")])])]),_._v(" "),v("hr"),_._v(" "),v("h2",{attrs:{id:"_4-返回值详解"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_4-返回值详解"}},[_._v("#")]),_._v(" 4. 返回值详解")]),_._v(" "),v("h3",{attrs:{id:"返回值-1-optimisticstate-例如-optimisticmessages-展示状态"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#返回值-1-optimisticstate-例如-optimisticmessages-展示状态"}},[_._v("#")]),_._v(" 返回值 1："),v("code",[_._v("optimisticState")]),_._v(" (例如："),v("code",[_._v("optimisticMessages")]),_._v(") - “展示状态”")]),_._v(" "),v("ul",[v("li",[v("strong",[_._v("它是什么？")]),_._v(" 这是一个**“混合”"),v("strong",[_._v("状态。它")]),_._v("不是**真实状态。")]),_._v(" "),v("li",[v("strong",[_._v("它的用法：")]),_._v(" 您"),v("strong",[_._v("必须")]),_._v("在您的 UI 渲染（比如 "),v("code",[_._v(".map()")]),_._v("）中使用"),v("strong",[_._v("这个")]),_._v("变量，"),v("strong",[_._v("而不是")]),_._v(" "),v("code",[_._v("realState")]),_._v("。\n"),v("ul",[v("li",[_._v("在“和平时期”（没有正在进行的 "),v("code",[_._v("action")]),_._v("），"),v("code",[_._v("optimisticState")]),_._v(" 的值"),v("strong",[_._v("等于")]),_._v(" "),v("code",[_._v("realState")]),_._v("。")]),_._v(" "),v("li",[_._v("在“等待时期”（您调用了 "),v("code",[_._v("addOptimistic")]),_._v(" 之后），"),v("code",[_._v("optimisticState")]),_._v(" 的值会**“领先”**于 "),v("code",[_._v("realState")]),_._v("，它会包含您“乐观”添加的那些假数据。")])])])]),_._v(" "),v("h3",{attrs:{id:"返回值-2-addoptimistic-例如-addoptimisticmessage-触发器"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#返回值-2-addoptimistic-例如-addoptimisticmessage-触发器"}},[_._v("#")]),_._v(" 返回值 2："),v("code",[_._v("addOptimistic")]),_._v(" (例如："),v("code",[_._v("addOptimisticMessage")]),_._v(") - “触发器”")]),_._v(" "),v("ul",[v("li",[v("p",[v("strong",[_._v("它是什么？")]),_._v(" 这是一个**“触发乐观更新”**的函数。")])]),_._v(" "),v("li",[v("p",[v("strong",[_._v("它的用法：")]),_._v(" 您"),v("strong",[_._v("必须")]),_._v("在您的异步 "),v("code",[_._v("action")]),_._v(" "),v("strong",[_._v("开始之前")]),_._v("（"),v("code",[_._v("await")]),_._v(" 之前）调用它。")]),_._v(" "),v("p",[v("strong",[_._v("例：")]),_._v(" "),v("code",[_._v('addOptimisticMessage("Hello")')]),_._v(" 当您调用它时，React 内部会：")]),_._v(" "),v("ol",[v("li",[_._v("找到您的“配方”（"),v("code",[_._v("updateFn")]),_._v("）。")]),_._v(" "),v("li",[_._v("执行它："),v("code",[_._v('updateFn(currentState, "Hello")')]),_._v("。")]),_._v(" "),v("li",[_._v("拿到您返回的“新乐观列表”。")]),_._v(" "),v("li",[v("strong",[_._v("立即")]),_._v("将 "),v("code",[_._v("optimisticState")]),_._v(" 更新为这个“新乐观列表”。")]),_._v(" "),v("li",[v("strong",[_._v("立即")]),_._v("触发 UI 重新渲染。")])])])]),_._v(" "),v("hr"),_._v(" "),v("h2",{attrs:{id:"_5-总结-完整的工作流程"}},[v("a",{staticClass:"header-anchor",attrs:{href:"#_5-总结-完整的工作流程"}},[_._v("#")]),_._v(" 5. 总结：完整的工作流程")]),_._v(" "),v("ol",[v("li",[v("strong",[_._v("用户操作：")]),_._v(" 用户点击“发送”。")]),_._v(" "),v("li",[v("strong",[_._v("action 启动：")]),_._v(" "),v("code",[_._v("formAction")]),_._v(" 被调用。")]),_._v(" "),v("li",[v("strong",[_._v("触发乐观：")]),_._v(" "),v("code",[_._v('addOptimisticMessage("Hello")')]),_._v(" "),v("strong",[_._v("立即")]),_._v("被调用。")]),_._v(" "),v("li",[v("strong",[_._v("React 执行“配方”：")]),_._v(" React 运行您的 "),v("code",[_._v("updateFn")]),_._v("，计算出“新的乐观列表”。")]),_._v(" "),v("li",[v("strong",[_._v("UI 立即更新：")]),_._v(" "),v("code",[_._v("optimisticMessages")]),_._v(" 变成了这个“新列表”，UI "),v("strong",[_._v("立即")]),_._v("重新渲染，用户"),v("strong",[_._v("立刻")]),_._v('看到 "Hello"。')]),_._v(" "),v("li",[v("strong",[_._v("await 开始：")]),_._v(" "),v("code",[_._v('fakeSubmitAction("Hello")')]),_._v(" "),v("strong",[_._v("才开始")]),_._v("在后台运行（模拟 2 秒延迟）。")]),_._v(" "),v("li",[v("strong",[_._v("（情况 A：失败）")]),_._v(" "),v("ul",[v("li",[v("code",[_._v("fakeSubmitAction")]),_._v(" 抛出错误 ("),v("code",[_._v("throw new Error")]),_._v(")。")]),_._v(" "),v("li",[v("code",[_._v("try...catch")]),_._v(" 块捕获到错误。")]),_._v(" "),v("li",[_._v("React "),v("strong",[_._v("自动")]),_._v("侦测到失败，"),v("strong",[_._v("立即")]),_._v("将 "),v("code",[_._v("optimisticMessages")]),_._v(" "),v("strong",[_._v("“回滚”")]),_._v(" 到 "),v("code",[_._v("realMessages")]),_._v('（参数 1）的状态。"Hello" 消息从 UI 上'),v("strong",[_._v("消失")]),_._v("。")])])]),_._v(" "),v("li",[v("strong",[_._v("（情况 B：成功）")]),_._v(" "),v("ul",[v("li",[v("code",[_._v("fakeSubmitAction")]),_._v(" 成功返回。")]),_._v(" "),v("li",[_._v("您的 "),v("code",[_._v("try")]),_._v(" 块调用 "),v("code",[_._v("setRealMessages(...)")]),_._v("，更新了“真实状态”。")]),_._v(" "),v("li",[_._v("React "),v("strong",[_._v("自动")]),_._v("侦测到 "),v("code",[_._v("realMessages")]),_._v(" 变了，它会**“确认”"),v("strong",[_._v("乐观更新，并用")]),_._v("新的 "),v("code",[_._v("realMessages")]),_._v("** 替换掉 "),v("code",[_._v("optimisticMessages")]),_._v("，UI 保持不变（或“发送中”标记消失）。")])])])])])}),[],!1,null,null,null);v.default=e.exports}}]);