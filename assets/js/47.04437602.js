(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{368:function(t,s,a){"use strict";a.r(s);var n=a(27),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"react-18-usesyncexternalstore"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#react-18-usesyncexternalstore"}},[t._v("#")]),t._v(" React 18+ useSyncExternalStore")]),t._v(" "),s("p",[s("code",[t._v("useSyncExternalStore")]),t._v(" 是 React 18 新增的一个 Hook，主要用于"),s("strong",[t._v("订阅和读取外部存储（store）的状态")]),t._v("，让 React 组件能够安全、正确地和外部状态源（比如全局状态管理库、浏览器 API 等）进行同步。这个 API 主要是为"),s("strong",[t._v("第三方状态管理库")]),t._v("设计的，也适合你自己实现订阅型外部数据源时使用。")]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"场景和价值"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#场景和价值"}},[t._v("#")]),t._v(" 场景和价值")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("状态管理库的桥梁")]),t._v("：如 Redux、MobX、Zustand、Recoil、Jotai 等库，未来都推荐基于这个 Hook 实现 React 绑定。")]),t._v(" "),s("li",[s("strong",[t._v("订阅外部全局状态")]),t._v("：如浏览器事件（localStorage、history、window resize、媒体查询等），或其他非 React 管理的数据源。")]),t._v(" "),s("li",[s("strong",[t._v("支持并发渲染（Concurrent Rendering）")]),t._v("：相比旧的“订阅+setState”方案，"),s("code",[t._v("useSyncExternalStore")]),t._v(" 可以保证外部数据和 React 渲染同步，避免数据撕裂问题。")])]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"基本用法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#基本用法"}},[t._v("#")]),t._v(" 基本用法")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" value "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useSyncExternalStore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("subscribe"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" getSnapshot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" getServerSnapshot"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("ul",[s("li",[s("strong",[t._v("subscribe")]),t._v("：订阅外部 store 状态变化的回调。接收一个回调参数（store 变化时调用），返回取消订阅的函数。")]),t._v(" "),s("li",[s("strong",[t._v("getSnapshot")]),t._v("：同步读取当前外部 store 状态的函数，返回当前值。")]),t._v(" "),s("li",[s("strong",[t._v("getServerSnapshot")]),t._v("（可选）：SSR 场景下用于获取服务端快照，一般可忽略。")])]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"简单示例-监听浏览器窗口宽度"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#简单示例-监听浏览器窗口宽度"}},[t._v("#")]),t._v(" 简单示例：监听浏览器窗口宽度")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" useSyncExternalStore "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"react"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("subscribe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("addEventListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"resize"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("removeEventListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"resize"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSnapshot")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" window"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("innerWidth"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useWindowWidth")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useSyncExternalStore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("subscribe"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" getSnapshot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Demo")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" width "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useWindowWidth")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("div"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("当前窗口宽度："),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("width"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("px"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("div"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("hr"),t._v(" "),s("h2",{attrs:{id:"示例-用在状态管理库"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#示例-用在状态管理库"}},[t._v("#")]),t._v(" 示例：用在状态管理库")]),t._v(" "),s("p",[t._v("如果你有一个全局 store（类似 Redux），可以这样写：")]),t._v(" "),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("subscribe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("callback")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 假设 store 有 subscribe 方法")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" store"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("subscribe")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("callback"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getSnapshot")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" store"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getState")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useStore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("useSyncExternalStore")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("subscribe"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" getSnapshot"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),s("hr"),t._v(" "),s("h2",{attrs:{id:"参数详解"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#参数详解"}},[t._v("#")]),t._v(" 参数详解")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("subscribe(callback)")]),t._v(" "),s("ul",[s("li",[t._v("当外部状态变化时，调用 callback 通知 React 组件更新。")]),t._v(" "),s("li",[t._v("返回一个取消订阅的函数。")])])]),t._v(" "),s("li",[s("strong",[t._v("getSnapshot()")]),t._v(" "),s("ul",[s("li",[t._v("读取当前外部状态（同步返回）。")]),t._v(" "),s("li",[t._v("必须保证每次调用都能准确拿到最新值。")])])]),t._v(" "),s("li",[s("strong",[t._v("getServerSnapshot（可选）")]),t._v(" "),s("ul",[s("li",[t._v("用于 SSR 场景下服务端快照，客户端可忽略。")])])])]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"为什么不用-useeffect-usestate-实现"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#为什么不用-useeffect-usestate-实现"}},[t._v("#")]),t._v(" 为什么不用 useEffect+useState 实现？")]),t._v(" "),s("ul",[s("li",[t._v("传统的 "),s("code",[t._v("useEffect + useState")]),t._v(" 在并发渲染下可能导致"),s("strong",[t._v("数据撕裂")]),t._v("（React 渲染和外部数据不同步）。")]),t._v(" "),s("li",[s("code",[t._v("useSyncExternalStore")]),t._v(" 能让 React 知道外部数据的变化和读取时机，保证一致性和正确性。")])]),t._v(" "),s("hr"),t._v(" "),s("h2",{attrs:{id:"总结"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("useSyncExternalStore")]),t._v(" 是连接外部状态和 React 组件的“官方桥梁”。")]),t._v(" "),s("li",[t._v("能保证并发渲染和 SSR/CSR 一致性，适合第三方状态库和自定义全局状态同步。")]),t._v(" "),s("li",[t._v("推荐用于“外部 store/全局状态/非 React 状态”的同步场景。")]),t._v(" "),s("li",[t._v("正确实现 subscribe/getSnapshot 就能让你的组件无缝订阅外部状态。")])]),t._v(" "),s("blockquote",[s("p",[t._v("如果你只是用 React 内部状态（useState/useReducer/useContext），一般不需要用它。只有和 React 体系外的状态（全局 store、原生事件等）同步时才用。")])])])}),[],!1,null,null,null);s.default=e.exports}}]);